# Feed Image Generation Flow

## Overview

The feed generation handler (`lib/maya/feed-generation-handler.ts`) **does NOT call image generation endpoints directly**. It only generates prompts and returns structured data. Image generation is handled by existing feed planner routes.

## Flow

### 1. Feed Creation
**Endpoint:** `/api/feed-planner/create-from-strategy`

- Creates feed layout in database
- Creates 9 feed posts with prompts (generated by `feed-generation-handler.ts`)
- Returns `feedId`

### 2. Image Generation Queue
**Endpoint:** `/api/feed-planner/queue-all-images`

- Calls `queueAllImagesForFeed()` function
- Queues all 9 posts for generation
- For each post:
  - **Classic Mode**: Calls `/api/feed/[feedId]/generate-single` with Classic Mode logic
  - **Pro Mode**: Calls `/api/feed/[feedId]/generate-single` with Pro Mode logic

### 3. Single Post Generation
**Endpoint:** `/api/feed/[feedId]/generate-single`

**Request:**
```json
{
  "postId": 123
}
```

**Response (Classic Mode):**
```json
{
  "predictionId": "abc123...",
  "success": true,
  "message": "Image generation started"
}
```

**Response (Pro Mode):**
```json
{
  "predictionId": "xyz789...",
  "success": true,
  "message": "Image generation started"
}
```

**Note:** This endpoint does NOT return `imageUrl` immediately because generation is async. It returns a `predictionId` that can be used to check status.

### 4. Status Checking
**Endpoint:** `/api/feed/[feedId]/check-post`

**Request:**
```
GET /api/feed/[feedId]/check-post?postId=123
```

**Response (while generating):**
```json
{
  "status": "generating",
  "predictionId": "abc123..."
}
```

**Response (when complete):**
```json
{
  "status": "complete",
  "imageUrl": "https://blob.vercel-storage.com/feed-posts/123.png",
  "predictionId": "abc123..."
}
```

## Image URL Format

Images are stored in Vercel Blob Storage:
- **Path:** `feed-posts/{postId}.png`
- **URL Format:** `https://blob.vercel-storage.com/feed-posts/{postId}.png`

## Generation Modes

### Classic Mode
- **Endpoint Logic:** Uses Replicate with user's LoRA model
- **Credits:** 1 credit per image
- **Response:** Returns `predictionId` from Replicate
- **Status Check:** Polls Replicate API via `/api/feed/[feedId]/check-post`

### Pro Mode
- **Endpoint Logic:** Uses Nano Banana Pro with reference images
- **Credits:** 2 credits per image
- **Response:** Returns `predictionId` from Nano Banana
- **Status Check:** Polls Nano Banana API via `/api/feed/[feedId]/check-post`

## Database Updates

1. **On generation start:**
   - `generation_status` = `'generating'`
   - `prediction_id` = prediction ID from Replicate/Nano Banana
   - `image_url` = `NULL`

2. **On generation complete (via webhook/polling):**
   - `generation_status` = `'complete'`
   - `image_url` = Blob storage URL
   - `prediction_id` = kept for reference

## Frontend Polling

The frontend polls `/api/feed/[feedId]/check-post` for each post until status is `'complete'` or `'failed'`.

## Verification Checklist

✅ **Feed creation endpoint exists:** `/api/feed-planner/create-from-strategy`
✅ **Image queue endpoint exists:** `/api/feed-planner/queue-all-images`
✅ **Single generation endpoint exists:** `/api/feed/[feedId]/generate-single`
✅ **Status check endpoint exists:** `/api/feed/[feedId]/check-post`
✅ **Response format verified:** Returns `predictionId`, not `imageUrl` immediately
✅ **Async generation handled:** Images updated via polling/webhook
✅ **Both modes supported:** Classic (Replicate) and Pro (Nano Banana)

## No Changes Needed

The `feed-generation-handler.ts` is correct as-is. It does NOT need to:
- Call image generation endpoints
- Handle async image generation
- Extract image URLs from responses

All of this is handled by the existing feed planner routes.


