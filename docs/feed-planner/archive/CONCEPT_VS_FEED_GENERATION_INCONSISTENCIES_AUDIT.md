# Feed Tab vs Concept Cards: Generation Logic Inconsistencies Audit

**Date:** 2025-01-XX  
**Scope:** Comparing image generation logic between Feed Tab (conversational feed creation) and Concept Cards (Photos Tab - immediate generation)

---

## Executive Summary

**CRITICAL CLARIFICATION:**
- **Feed Tab in Maya Chat**: Users chat with Maya â†’ Maya creates feed strategy/posts (stores prompts/captions in DB) â†’ **NO images generated yet**
- **Feed Planner Screen**: View-only display of created feed (images generated later when user clicks "Generate")
- **Concept Cards (Photos Tab)**: Users chat with Maya â†’ Maya generates concepts â†’ **Images generated IMMEDIATELY**

This audit compares how images are **generated** from prompts:
- **Feed Posts**: When generating images from stored feed posts (via `/api/feed/[feedId]/generate-single` or `queue-images.ts`)
- **Concept Cards**: When generating images immediately in Photos Tab (via `/api/maya/generate-image` or `/api/maya/generate-studio-pro`)

Both support Classic Mode (custom FLUX model + LoRA) and Pro Mode (Nanobanana + reference images), but there are significant inconsistencies in the generation implementation.

---

## Architecture Overview

### Feed Posts Image Generation (After Feed Creation)
- **Classic Mode**: `/api/feed/[feedId]/generate-single` â†’ Replicate (custom FLUX model)
- **Pro Mode**: `lib/feed-planner/queue-images.ts` â†’ Nanobanana (via `generateWithNanoBanana`)
- **Entry Point**: Feed Planner Screen â†’ User clicks "Generate" on post â†’ Uses stored prompt from DB

### Concept Cards (Photos Tab - Immediate Generation)
- **Classic Mode**: `/api/maya/generate-image` â†’ Replicate (custom FLUX model)
- **Pro Mode**: `/api/maya/generate-studio-pro` â†’ Nanobanana (via `generateWithNanoBanana`)
- **Entry Point**: Maya Chat Photos Tab â†’ User requests concept â†’ Image generated immediately

---

## Critical Inconsistencies Found

### 1. **Prompt Generation Pipeline** ðŸ”´ HIGH PRIORITY

**Feed Posts (Classic Mode):**
- **Prompt Source**: Stored in `feed_posts.prompt` (generated during feed creation in Feed Tab)
- **When Generating Images**: Calls `/api/maya/generate-feed-prompt` to **enhance/regenerate** the stored prompt
- **Enhancement Input**: `postType`, `caption`, `feedPosition`, `colorTheme`, `brandVibe`, `referencePrompt` (stored prompt), `isRegeneration`, `category`
- **Result**: Enhanced prompt with feed context, feed position awareness, brand vibe integration
- **File**: `app/api/feed/[feedId]/generate-single/route.ts:181-324`

**Concept Cards (Classic Mode):**
- **Prompt Source**: Generated on-demand by `/api/maya/chat` (Maya generates prompt during conversation)
- **When Generating Images**: Uses prompt directly from chat (passed as `conceptPrompt` parameter)
- **Input**: `conceptPrompt` (pre-generated by Maya in chat context)
- **Enhancement**: Only trigger word validation/prefix check, no re-generation
- **File**: `app/api/maya/generate-image/route.ts:158-167`

**Key Difference:**
- Feed posts: **Always re-enhance** stored prompts before generation (adds feed context)
- Concept cards: **Use prompt as-is** from chat (no re-enhancement)

**Impact:** Feed posts get better prompts with feed-specific context (position, brand vibe, color theme), while concept cards rely purely on chat context. This is by design but creates inconsistency in prompt quality.

---

### 2. **Seed Handling & Photoshoot Mode** ðŸ”´ HIGH PRIORITY

**Feed Cards:**
- Supports photoshoot mode: `feed_layouts.photoshoot_enabled`
- Uses `photoshoot_base_seed` + `seed_variation` for consistency
- Seeds applied in Replicate input: `seed: feedLayout.photoshoot_base_seed + seedVariation`
- File: `app/api/feed/[feedId]/generate-single/route.ts:360-365`

**Concept Cards:**
- Photoshoot is ONLY in Classic Mode (uses seeds + user's trained LoRA)
- Uses `app/api/maya/create-photoshoot` route
- Seeds generated dynamically: `baseSeed` + pose variations
- Different seed generation logic

**Impact:** Feed photoshoot mode exists but concept photoshoot is separate implementation.

---

### 3. **Model Version ID Extraction** ðŸŸ¡ MEDIUM PRIORITY

**Feed Cards:**
```typescript
// app/api/feed/[feedId]/generate-single/route.ts:136-139
let replicateVersionId = model.replicate_version_id
if (replicateVersionId && replicateVersionId.includes(':')) {
  const parts = replicateVersionId.split(':')
  replicateVersionId = parts[parts.length - 1] // Extract hash only
}
```
- Also in `regenerate-post/route.ts:97-101`

**Concept Cards:**
```typescript
// app/api/maya/generate-image/route.ts:117-125
let replicateVersionId = userData.replicate_version_id
if (replicateVersionId && replicateVersionId.includes(':')) {
  const parts = replicateVersionId.split(':')
  replicateVersionId = parts[parts.length - 1] // Extract hash only
}
```
- Same logic but duplicated code

**Impact:** Code duplication, but logic is consistent. Should be extracted to shared utility.

---

### 4. **Quality Settings Application** ðŸŸ¡ MEDIUM PRIORITY

**Feed Cards:**
```typescript
// app/api/feed/[feedId]/generate-single/route.ts:326-331
const qualitySettings = MAYA_QUALITY_PRESETS[post.post_type as keyof typeof MAYA_QUALITY_PRESETS] 
  || MAYA_QUALITY_PRESETS.default

if (model.lora_scale !== null && model.lora_scale !== undefined) {
  qualitySettings.lora_scale = Number(model.lora_scale)
}
```
- Uses `post.post_type` for category mapping
- Overrides `lora_scale` from model
- No custom settings support

**Concept Cards:**
```typescript
// app/api/maya/generate-image/route.ts:187-233
const categoryKey = category as keyof typeof MAYA_QUALITY_PRESETS
const presetSettings = MAYA_QUALITY_PRESETS[categoryKey] || MAYA_QUALITY_PRESETS.default

const qualitySettings = {
  ...presetSettings,
  aspect_ratio: customSettings?.aspectRatio || presetSettings.aspect_ratio,
  lora_scale: customSettings?.styleStrength !== undefined
    ? customSettings.styleStrength  // User manual override
    : (userLoraScale ?? presetSettings.lora_scale),
  guidance_scale: customSettings?.promptAccuracy ?? presetSettings.guidance_scale,
  extra_lora_scale: shouldDisableExtraLora ? 0 : (hasUserSetRealism ? manualExtraLoraScale : presetSettings.extra_lora_scale),
}
```
- Uses `category` parameter for mapping
- Supports `customSettings` (styleStrength, promptAccuracy, aspectRatio, realismStrength)
- Complex priority logic for extra_lora_scale
- Enhanced Authenticity toggle support

**Impact:** Feed cards don't support user customizations (style strength, prompt accuracy, etc.). Concept cards have richer customization.

---

### 5. **Trigger Word Handling** ðŸŸ¡ MEDIUM PRIORITY

**Feed Cards:**
```typescript
// app/api/feed/[feedId]/generate-single/route.ts:306-314
const promptLower = finalPrompt.toLowerCase().trim()
const triggerLower = model.trigger_word.toLowerCase()
if (!promptLower.startsWith(triggerLower)) {
  console.log("[v0] [GENERATE-SINGLE] âš ï¸ Trigger word not at start, prepending:", model.trigger_word)
  finalPrompt = `${model.trigger_word}, ${finalPrompt}`
}
```
- Validates and prepends trigger word after Maya prompt generation

**Concept Cards:**
```typescript
// app/api/maya/generate-image/route.ts:158-167
let finalPrompt = conceptPrompt.trim()
const promptLower = finalPrompt.toLowerCase()
const triggerLower = triggerWord.toLowerCase()

if (!promptLower.startsWith(triggerLower)) {
  finalPrompt = `${triggerWord}, ${finalPrompt}`
  console.log("[v0] Added trigger word to start of prompt")
}
```
- Same logic but simpler (no Maya enhancement step)

**Impact:** Logic is consistent, but feed cards validate after Maya enhancement.

---

### 6. **Enhanced Authenticity Toggle** ðŸŸ¡ MEDIUM PRIORITY

**Feed Cards:**
- âŒ **NOT SUPPORTED** - No enhanced authenticity toggle in feed generation

**Concept Cards:**
```typescript
// app/api/maya/generate-image/route.ts:180-185
if (enhancedAuthenticity === true) {
  finalPrompt = `${finalPrompt}, muted colors, iPhone quality, film grain, authentic cellphone photo aesthetic, natural skin texture with visible pores, amateur cellphone quality, visible sensor noise, heavy HDR glow, blown-out highlights, crushed shadows, authentic moment, unfiltered, real life texture`
}
```
- âœ… **SUPPORTED** - Adds authentic iPhone aesthetic keywords
- Also disables extra LoRA scale when enabled

**Impact:** Feed cards can't produce authentic iPhone-style images on demand.

---

### 7. **Pro Mode Image Source** ðŸŸ¡ MEDIUM PRIORITY

**Feed Cards (Pro Mode):**
- Uses `imageLibrary` passed to `queue-images.ts`
- Falls back to querying `user_avatar_images` if library not provided
- File: `lib/feed-planner/queue-images.ts:132-148`

**Concept Cards (Pro Mode):**
- Uses `inputImages` from request body
- Gets images from Maya Chat image library modal
- File: `app/api/maya/generate-studio-pro/route.ts:95-127`

**Impact:** Different image source mechanisms, but both work. Should standardize.

---

### 8. **Replicate API Input Structure** ðŸŸ¢ LOW PRIORITY

**Feed Cards (Classic):**
```typescript
// app/api/feed/[feedId]/generate-single/route.ts:342-358
const generationInput: any = {
  prompt: finalPrompt,
  guidance_scale: qualitySettings.guidance_scale,
  num_inference_steps: qualitySettings.num_inference_steps,
  aspect_ratio: qualitySettings.aspect_ratio,
  megapixels: qualitySettings.megapixels,
  output_format: qualitySettings.output_format,
  output_quality: qualitySettings.output_quality,
  lora_scale: Number(qualitySettings.lora_scale),
  hf_lora: model.lora_weights_url,
  extra_lora: qualitySettings.extra_lora,
  extra_lora_scale: qualitySettings.extra_lora_scale,
  disable_safety_checker: qualitySettings.disable_safety_checker ?? true,
  go_fast: qualitySettings.go_fast ?? false,
  num_outputs: qualitySettings.num_outputs ?? 1,
  model: qualitySettings.model ?? "dev",
  // Optional: seed if photoshoot mode
  ...(feedLayout?.photoshoot_enabled && feedLayout?.photoshoot_base_seed && {
    seed: feedLayout.photoshoot_base_seed + seedVariation
  })
}
```

**Concept Cards (Classic):**
```typescript
// app/api/maya/generate-image/route.ts:299-314
const predictionInput: any = {
  prompt: finalPrompt,
  guidance_scale: qualitySettings.guidance_scale,
  num_inference_steps: qualitySettings.num_inference_steps,
  aspect_ratio: qualitySettings.aspect_ratio,
  megapixels: qualitySettings.megapixels,
  output_format: qualitySettings.output_format,
  output_quality: qualitySettings.output_quality,
  lora_scale: Number(qualitySettings.lora_scale),
  hf_lora: loraWeightsUrl,
  seed: customSettings?.seed || qualitySettings.seed || Math.floor(Math.random() * 1000000),
  disable_safety_checker: qualitySettings.disable_safety_checker ?? true,
  go_fast: qualitySettings.go_fast ?? false,
  num_outputs: qualitySettings.num_outputs ?? 1,
  model: qualitySettings.model ?? "dev",
  // Conditional: extra_lora only if scale > 0
  ...(qualitySettings.extra_lora && qualitySettings.extra_lora_scale > 0 && {
    extra_lora: qualitySettings.extra_lora,
    extra_lora_scale: qualitySettings.extra_lora_scale
  }),
  // Conditional: reference image if provided
  ...(referenceImageUrl && { image: referenceImageUrl })
}
```

**Differences:**
- Feed: Always includes `extra_lora` and `extra_lora_scale` (even if 0)
- Concept: Conditionally includes `extra_lora` only if scale > 0
- Feed: Uses seed only in photoshoot mode
- Concept: Always uses seed (custom or random)
- Concept: Supports `image` parameter for reference images

**Impact:** Feed cards may send unnecessary parameters. Concept cards have more refined conditional logic.

---

### 9. **Credit Deduction Timing** ðŸŸ¡ MEDIUM PRIORITY

**Feed Cards:**
- Credits deducted AFTER prediction creation
- File: `app/api/feed/[feedId]/generate-single/route.ts:381-394`
- Uses `deductCredits` helper

**Concept Cards:**
- Credits deducted AFTER prediction creation
- File: `app/api/maya/generate-image/route.ts:349-359`
- Uses `deductCredits` helper

**Impact:** Consistent timing (both after creation), but both should deduct BEFORE to prevent free generations on API failures.

---

### 10. **Error Handling & Rollback** ðŸŸ¡ MEDIUM PRIORITY

**Feed Cards:**
- If credits deduction fails, continues anyway (logs error)
- File: `app/api/feed/[feedId]/generate-single/route.ts:389-394`
- No rollback mechanism

**Concept Cards:**
- If credits deduction fails, continues anyway (logs error)
- File: `app/api/maya/generate-image/route.ts:357-359`
- No rollback mechanism

**Impact:** Both have same issue - prediction created but credits may not be deducted. Should deduct BEFORE prediction.

---

### 11. **Pro Mode Prompt Generation** ðŸ”´ HIGH PRIORITY

**Feed Cards (Pro Mode):**
- Uses `buildNanoBananaPrompt` from `@/lib/maya/nano-banana-prompt-builder`
- Prompt generated during feed creation (`create-from-strategy`)
- Stored in `feed_posts.prompt`
- Regenerates only if missing
- File: `lib/feed-planner/queue-images.ts:159-196`

**Concept Cards (Pro Mode):**
- Uses `buildNanoBananaPrompt` from `@/lib/maya/nano-banana-prompt-builder`
- Prompt generated in Maya chat (`/api/maya/chat`)
- Passed directly to `/api/maya/generate-studio-pro`
- Uses structured prompt sections (Outfit, Pose, Setting)
- File: `app/api/maya/generate-studio-pro/route.ts:59-78`

**Impact:** Both use same builder, but feed pre-generates prompts while concepts generate on-demand.

---

## Standardization Plan

### Phase 1: Core Shared Logic (Priority: HIGH)

#### 1.1 Extract Model Version ID Extraction
**File:** `lib/replicate-helpers.ts` (new file)
```typescript
export function extractReplicateVersionId(fullVersionId: string | null | undefined): string {
  if (!fullVersionId) return ''
  if (fullVersionId.includes(':')) {
    const parts = fullVersionId.split(':')
    return parts[parts.length - 1] // Extract hash only
  }
  return fullVersionId
}
```

**Apply to:**
- `app/api/feed/[feedId]/generate-single/route.ts`
- `app/api/feed/[feedId]/regenerate-post/route.ts`
- `app/api/maya/generate-image/route.ts`

---

#### 1.2 Extract Trigger Word Validation
**File:** `lib/replicate-helpers.ts`
```typescript
export function ensureTriggerWordPrefix(prompt: string, triggerWord: string): string {
  const promptLower = prompt.toLowerCase().trim()
  const triggerLower = triggerWord.toLowerCase()
  
  if (!promptLower.startsWith(triggerLower)) {
    return `${triggerWord}, ${prompt}`
  }
  return prompt
}
```

**Apply to:**
- `app/api/feed/[feedId]/generate-single/route.ts`
- `app/api/maya/generate-image/route.ts`

---

#### 1.3 Extract Replicate Input Builder
**File:** `lib/replicate-helpers.ts`
```typescript
export interface ClassicModeInput {
  prompt: string
  qualitySettings: QualitySettings
  loraWeightsUrl: string
  seed?: number
  referenceImageUrl?: string | string[]
  extraLoraDisabled?: boolean
}

export function buildClassicModeReplicateInput(params: ClassicModeInput): any {
  const {
    prompt,
    qualitySettings,
    loraWeightsUrl,
    seed,
    referenceImageUrl,
    extraLoraDisabled = false
  } = params

  const input: any = {
    prompt,
    guidance_scale: qualitySettings.guidance_scale,
    num_inference_steps: qualitySettings.num_inference_steps,
    aspect_ratio: qualitySettings.aspect_ratio,
    megapixels: qualitySettings.megapixels,
    output_format: qualitySettings.output_format,
    output_quality: qualitySettings.output_quality,
    lora_scale: Number(qualitySettings.lora_scale),
    hf_lora: loraWeightsUrl,
    disable_safety_checker: qualitySettings.disable_safety_checker ?? true,
    go_fast: qualitySettings.go_fast ?? false,
    num_outputs: qualitySettings.num_outputs ?? 1,
    model: qualitySettings.model ?? "dev",
  }

  // Only include extra_lora if scale > 0 (refined logic from concept cards)
  if (qualitySettings.extra_lora && qualitySettings.extra_lora_scale > 0 && !extraLoraDisabled) {
    input.extra_lora = qualitySettings.extra_lora
    input.extra_lora_scale = qualitySettings.extra_lora_scale
  }

  // Include seed if provided (always for concept cards, conditional for feed)
  if (seed !== undefined) {
    input.seed = seed
  }

  // Include reference image if provided (concept cards only)
  if (referenceImageUrl) {
    const imageUrl = Array.isArray(referenceImageUrl) 
      ? referenceImageUrl.find(url => url)
      : referenceImageUrl
    if (imageUrl) {
      input.image = imageUrl
    }
  }

  return input
}
```

**Apply to:**
- `app/api/feed/[feedId]/generate-single/route.ts`
- `app/api/feed/[feedId]/regenerate-post/route.ts`
- `app/api/maya/generate-image/route.ts`

---

### Phase 2: Feature Parity (Priority: HIGH)

#### 2.1 Add Enhanced Authenticity to Feed Cards
**File:** `app/api/feed/[feedId]/generate-single/route.ts`

Add support for enhanced authenticity toggle:
```typescript
const { postId, enhancedAuthenticity } = await req.json()

// After prompt generation, apply enhanced authenticity if enabled
if (enhancedAuthenticity === true) {
  finalPrompt = `${finalPrompt}, muted colors, iPhone quality, film grain, authentic cellphone photo aesthetic, natural skin texture with visible pores, amateur cellphone quality, visible sensor noise, heavy HDR glow, blown-out highlights, crushed shadows, authentic moment, unfiltered, real life texture`
  // Also disable extra LoRA
  qualitySettings.extra_lora_scale = 0
}
```

**UI:** Add toggle to feed post card generation UI.

---

#### 2.2 Add Custom Settings to Feed Cards
**File:** `app/api/feed/[feedId]/generate-single/route.ts`

Add support for custom settings:
```typescript
const { postId, customSettings } = await req.json()

// Apply custom settings to quality presets
if (customSettings) {
  if (customSettings.aspectRatio) {
    qualitySettings.aspect_ratio = customSettings.aspectRatio
  }
  if (customSettings.styleStrength !== undefined) {
    qualitySettings.lora_scale = customSettings.styleStrength
  }
  if (customSettings.promptAccuracy !== undefined) {
    qualitySettings.guidance_scale = customSettings.promptAccuracy
  }
  if (customSettings.realismStrength !== undefined && !enhancedAuthenticity) {
    qualitySettings.extra_lora_scale = customSettings.realismStrength
  }
}
```

**UI:** Add settings panel to feed post card (advanced options).

---

#### 2.3 Unify Prompt Generation for Feed Cards
**Decision Needed:** Should feed cards use Maya's prompt generation (like concepts) or keep separate `generate-feed-prompt` route?

**Recommendation:** Keep separate route but ensure both use same quality principles and trigger word handling.

---

### Phase 3: Photoshoot Mode Consistency (Priority: MEDIUM)

#### 3.1 Standardize Seed Generation
**Decision:** Should concept photoshoot use same seed logic as feed photoshoot?

**Feed Photoshoot:**
- Uses `photoshoot_base_seed` from `feed_layouts`
- Adds `seed_variation` per post (0, 1, 2, ...)

**Concept Photoshoot:**
- Generates `baseSeed` randomly
- Adds pose-specific variations

**Recommendation:** Keep separate for now (feed = consistent feed, concept = dynamic photoshoot), but document the difference clearly.

---

#### 3.2 Add Photoshoot Mode to Concept Cards UI
Currently photoshoot is only in Classic Mode. Consider adding photoshoot toggle to concept cards for consistency.

---

### Phase 4: Credit Deduction & Error Handling (Priority: MEDIUM)

#### 4.1 Move Credit Deduction BEFORE Prediction
**Apply to all routes:**
- `app/api/feed/[feedId]/generate-single/route.ts`
- `app/api/maya/generate-image/route.ts`
- `app/api/maya/generate-studio-pro/route.ts`

**Pattern:**
```typescript
// 1. Validate credits first
const hasCredits = await checkCredits(user.id, CREDIT_COSTS.IMAGE)
if (!hasCredits) {
  return NextResponse.json({ error: "Insufficient credits" }, { status: 402 })
}

// 2. Deduct credits BEFORE prediction
const deduction = await deductCredits(user.id, CREDIT_COSTS.IMAGE, ...)
if (!deduction.success) {
  return NextResponse.json({ error: "Failed to deduct credits" }, { status: 500 })
}

// 3. Create prediction
const prediction = await replicate.predictions.create(...)

// 4. If prediction fails, refund credits
try {
  // ... prediction creation
} catch (error) {
  await addCredits(user.id, CREDIT_COSTS.IMAGE, "refund", "Generation failed")
  throw error
}
```

---

### Phase 5: Pro Mode Consistency (Priority: LOW)

#### 5.1 Standardize Image Library Source
**Decision:** Should both use same image library mechanism?

**Current:**
- Feed: `imageLibrary` parameter + fallback to `user_avatar_images`
- Concept: `inputImages` from request body

**Recommendation:** Keep as-is (both work), but ensure fallback logic is consistent.

---

#### 5.2 Unify Prompt Pre-generation vs On-Demand
**Current:**
- Feed: Pre-generates prompts during feed creation
- Concept: Generates prompts on-demand in chat

**Recommendation:** Keep as-is - different UX patterns require different approaches. Feed benefits from pre-generation (batch), concepts benefit from on-demand (interactive).

---

## Testing Plan

### Test Cases to Add

1. **Model Version ID Extraction**
   - Test with full format: `"owner/model:hash"`
   - Test with hash only: `"hash"`
   - Test with null/undefined

2. **Trigger Word Handling**
   - Test with prompt starting with trigger word
   - Test with prompt missing trigger word
   - Test case-insensitive matching

3. **Quality Settings Application**
   - Test custom settings override
   - Test database lora_scale override
   - Test preset defaults fallback

4. **Enhanced Authenticity**
   - Test with toggle ON (should disable extra LoRA)
   - Test with toggle OFF (should use normal settings)

5. **Credit Deduction**
   - Test deduction BEFORE prediction
   - Test refund on prediction failure
   - Test insufficient credits error

6. **Photoshoot Seeds**
   - Test feed photoshoot seed consistency
   - Test concept photoshoot seed variations

---

## Migration Checklist

- [ ] Phase 1.1: Extract model version ID helper
- [ ] Phase 1.2: Extract trigger word helper
- [ ] Phase 1.3: Extract Replicate input builder
- [ ] Phase 2.1: Add enhanced authenticity to feed cards
- [ ] Phase 2.2: Add custom settings to feed cards
- [ ] Phase 4.1: Move credit deduction before prediction
- [ ] Phase 4.2: Add refund logic on prediction failure
- [ ] Phase 5: Document Pro Mode differences
- [ ] Add tests for all shared helpers
- [ ] Update both routes to use shared helpers

---

## Notes

- **Photoshoot Mode:** Currently different between feed and concepts by design (feed = consistent feed, concepts = dynamic variations). This is acceptable but should be documented.

- **Pro Mode Prompts:** Feed pre-generates, concepts generate on-demand. Both are valid patterns for their use cases.

- **Priority:** Focus on Phase 1 (shared logic) and Phase 2 (feature parity) first. Phases 3-5 are lower priority improvements.

---

## Files to Modify

### New Files
- `lib/replicate-helpers.ts` - Shared Replicate utilities

### Modified Files
- `app/api/feed/[feedId]/generate-single/route.ts`
- `app/api/feed/[feedId]/regenerate-post/route.ts`
- `app/api/maya/generate-image/route.ts`
- `components/feed-planner/feed-post-card.tsx` (add settings UI)
- `lib/feed-planner/queue-images.ts` (use shared helpers)

---

**Next Steps:**
1. Review this audit with Sandra
2. Prioritize phases based on business needs
3. Start with Phase 1 (shared logic extraction)
4. Test thoroughly before moving to Phase 2

