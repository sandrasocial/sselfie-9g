# Maya Prompt Flow Trace - Complete Documentation

**Date:** January 2025  
**Purpose:** Document the complete flow of prompts from generation ‚Üí saving ‚Üí sending to Replicate

---

## Problem Statement

Maya is:
1. Still injecting "visible pores" when it shouldn't
2. Not respecting scenes in concept cards consistently
3. Need to trace what's being saved, what's sent to Replicate, and what's used in concept cards

---

## Complete Prompt Flow

### 1. **PROMPT GENERATION**
**File:** `app/api/maya/generate-concepts/route.ts`

**Process:**
1. Maya's AI generates concepts via `generateText` with Claude (lines ~1900-2000)
2. Prompts are extracted from Claude's JSON response
3. Guide prompt variations are created (lines 1995-2104)
4. Post-processing is applied (lines 2107-2998)

**Key Functions:**
- `createVariationFromGuidePrompt()` - Creates variations maintaining consistency
- `ensureRequiredElements()` - Adds required elements (with conditional skin texture)
- `minimalCleanup()` - Final cleanup

**Critical Post-Processing Steps:**
- Line 2977-2981: `ensureRequiredElements()` is SKIPPED for guide prompt concepts
- Line 2988-2996: Minimal cleanup for guide prompts vs full cleanup for others
- Line 2998: `concept.prompt = prompt` - **THIS IS WHAT GETS SAVED**

### 2. **PROMPT SAVING**
**File:** `app/api/maya/generate-concepts/route.ts` (line 3049)

**What Gets Saved:**
```json
{
  "state": "ready",
  "concepts": [
    {
      "prompt": "...",  // This is the FINAL prompt after all post-processing
      "title": "...",
      "description": "...",
      // ... other fields
    }
  ]
}
```

**Where It's Saved:**
- Returned to frontend as JSON response
- Frontend saves to `maya_chat_messages.concept_cards` column (via `save-message` route)
- Each concept card stores its `prompt` field

### 3. **PROMPT USAGE IN STUDIO PRO MODE**
**File:** `components/sselfie/concept-card.tsx` (line 442)

**Process:**
1. User clicks "Generate" on concept card
2. Line 442: `const userRequest = editedPrompt || concept.prompt || ...`
3. Line 444: Calls `/api/maya/generate-studio-pro` with `userRequest` (which is `concept.prompt`)

**API Route:** `app/api/maya/generate-studio-pro/route.ts`
- Line 56: Calls `buildNanoBananaPrompt({ userRequest, ... })`
- Line 169: Sends `optimizedPrompt` to Replicate via `generateWithNanoBanana()`

### 4. **PROMPT TRANSFORMATION IN STUDIO PRO**
**File:** `lib/maya/nano-banana-prompt-builder.ts`

**Critical Function:** `buildBrandScenePrompt()` (line 609)

**Detection Logic (lines 618-802):**
- Detects if `userRequest` is already a Maya detailed prompt
- If detected: Uses prompt AS-IS (line 725: `let finalPrompt = userRequest`)
- If NOT detected: Rebuilds prompt from scratch (lines 804-886)

**Detection Criteria (lines 661-674):**
- Has section headers (`**OUTFIT & STYLING:**`, etc.)
- Starts with attachment reference (`Woman, maintaining exactly...`)
- Has specific details (clothing, scene, lighting, etc.)
- Detail count >= 2-4

**If Detection Fails:**
- Prompt gets rebuilt with generic structure
- This could lose scene/location details!
- Could add unwanted elements

---

## Issues Identified

### Issue 1: Visible Pores Injection
**Location:** `app/api/maya/generate-concepts/route.ts` line 2307-2323

**Problem:**
- Code adds "natural skin texture with visible pores" without checking `shouldIncludeSkinTexture`
- Variable `shouldAddSkinTexture` is declared AFTER this code (line 2362)
- This causes skin texture to always be added

**Fix Applied:**
- Moved `shouldAddSkinTexture` check BEFORE the skin texture addition
- Added conditional logic to only add if it should be included

### Issue 2: Scene Not Respected
**Location:** `lib/maya/nano-banana-prompt-builder.ts` line 690-802

**Problem:**
- `buildBrandScenePrompt` detection might fail to recognize Maya prompts
- If detection fails, prompt gets rebuilt, losing scene/location details
- Generic fallback (line 867-886) doesn't preserve specific scenes

**Potential Issues:**
- Detection criteria might be too strict
- Scene/location details might not match detection patterns
- Fallback rebuild loses user's specific scene descriptions

### Issue 3: Prompt Inconsistency
**Location:** Multiple locations

**Problem:**
- Prompt goes through multiple transformations:
  1. Generated by Claude
  2. Post-processed in `generate-concepts`
  3. Detected/transformed in `buildBrandScenePrompt`
  4. Sent to Replicate

- Each step could modify the prompt
- What's saved might differ from what's sent to Replicate

---

## Logging Added

**File:** `app/api/maya/generate-concepts/route.ts`

**Added Logging:**
- Line 2999-3005: Logs final prompt for each concept (what gets saved)
- Line 3049-3059: Logs all final prompts before returning (what gets sent to frontend)

**Log Format:**
```
[v0] üìù FINAL PROMPT #X (what will be saved/sent to Replicate): ...
[v0] üìù PROMPT #X FULL LENGTH: ... chars
[v0] üìù PROMPT #X contains 'visible pores': true/false
[v0] üìù PROMPT #X contains location/scene: true/false
```

**File:** `app/api/maya/generate-studio-pro/route.ts`

**Existing Logging:**
- Line 159-166: Logs prompt sent to Nano Banana (includes full prompt)

---

## Recommendations

1. **Fix Visible Pores Issue:**
   - ‚úÖ FIXED: Added conditional check before adding skin texture

2. **Improve Scene Detection:**
   - Add more detection patterns for scenes/locations
   - Log when detection fails
   - Ensure scene details are preserved

3. **Add Consistency Checks:**
   - Log prompts at each transformation step
   - Compare what's saved vs what's sent to Replicate
   - Ensure guide prompt variations preserve scenes

4. **Test Flow:**
   - Generate concepts with specific scenes
   - Check logs to see what's saved
   - Check logs to see what's sent to Replicate
   - Verify they match

---

## Files Modified

1. **`app/api/maya/generate-concepts/route.ts`**
   - Fixed skin texture injection (line 2307-2323)
   - Added logging for final prompts

2. **`lib/maya/nano-banana-prompt-builder.ts`**
   - Review detection logic for Maya prompts
   - Ensure scenes are preserved when using prompts as-is

---

## Next Steps

1. ‚úÖ Fix visible pores injection (DONE)
2. Review scene detection in `buildBrandScenePrompt`
3. Add logging to `buildBrandScenePrompt` to see when detection fails
4. Test complete flow end-to-end

