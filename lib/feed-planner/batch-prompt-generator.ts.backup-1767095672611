/**
 * Batch Feed Prompt Generator
 * 
 * Shared logic for generating all 9 feed prompts in a single API call.
 * Can be called directly (not via HTTP) for use in queue-images.ts
 * 
 * Week 2 Optimization: Reduces 9 API calls to 1 (89% reduction)
 */

import { neon } from "@neondatabase/serverless"
import { getUserContextForMaya } from "@/lib/maya/get-user-context"
import { getMayaPersonality } from "@/lib/maya/personality-enhanced"
import { getFluxPromptingPrinciples } from "@/lib/maya/flux-prompting-principles"

const sql = neon(process.env.DATABASE_URL || "")

interface FeedPost {
  position: number
  postType: string
  caption?: string
  category?: string
  contentPillar?: string
  narrativeRole?: string
  storyConcept?: string
  valueConcept?: string
  hookConcept?: string
  ctaConcept?: string
}

interface BatchPromptParams {
  posts: FeedPost[]
  userId: number
  feedId: number
  feedStrategy?: string
  brandColors?: string
}

interface PromptResult {
  position: number
  prompt: string
  error?: string
}

export async function generateBatchPrompts(params: BatchPromptParams): Promise<{
  success: boolean
  prompts: PromptResult[]
  tokenUsage?: {
    input_tokens: number
    output_tokens: number
    cache_read: number
  }
  error?: string
}> {
  const { posts, userId, feedId, feedStrategy, brandColors } = params

  try {
    // Validate input
    if (!posts || posts.length !== 9) {
      return {
        success: false,
        prompts: [],
        error: `Exactly 9 posts required, got ${posts.length}`
      }
    }

    console.log("[Maya] [BATCH-FEED-PROMPT] Generating batch prompts for 9 posts...")

    // Get user model details and auth ID
    const [userData] = await sql`
      SELECT 
        u.stack_auth_id,
        u.supabase_user_id,
        um.trigger_word, 
        u.gender, 
        u.ethnicity, 
        um.physical_preferences
      FROM users u
      LEFT JOIN user_models um ON u.id = um.user_id AND um.training_status = 'completed'
      LEFT JOIN user_personal_brand upb ON u.id = upb.user_id
      WHERE u.id = ${userId}
      ORDER BY um.created_at DESC
      LIMIT 1
    `

    if (!userData || !userData.trigger_word) {
      return {
        success: false,
        prompts: [],
        error: "User model not found or trigger word missing"
      }
    }

    const userContext = {
      triggerWord: userData.trigger_word,
      userEthnicity: userData.ethnicity,
      userGender: userData.gender,
      userAge: userData.physical_preferences,
    }

    // Get auth ID for getUserContextForMaya (it expects a string auth ID, not user ID)
    const authId = userData.stack_auth_id || userData.supabase_user_id || String(userId)
    
    // Get user context for Maya (requires auth ID string, not user ID number)
    const mayaUserContext = await getUserContextForMaya(authId)
    
    // Build comprehensive system prompt with caching
    const mayaPersonality = getMayaPersonality()
    const fluxPrinciples = getFluxPromptingPrinciples()

    const systemPrompt = `${mayaPersonality}

${mayaUserContext}

${fluxPrinciples}

=== YOUR TASK: GENERATE 9 INSTAGRAM FEED POST PROMPTS IN BATCH ===

You are Maya, an elite AI Fashion Stylist generating FLUX prompts for an Instagram feed. This is NOT for concept cards - these are for the user's actual Instagram feed that will be published.

Apply YOUR fashion expertise:
- Create SPECIFIC outfit descriptions (material + color + garment type), NOT generic terms like "trendy outfit"
- Use YOUR fashion intelligence to suggest sophisticated, brand-aligned styling
- Include detailed location descriptions that match the brand aesthetic
- Apply natural, authentic posing and expressions
- Create cinematic lighting that feels authentic, not staged

FEED STRATEGY CONTEXT:
${feedStrategy || "No specific feed strategy provided."}

USER ATTRIBUTES:
- Trigger word: ${userContext.triggerWord}
- Ethnicity: ${userContext.userEthnicity || 'not specified'}
- Gender: ${userContext.userGender || 'not specified'}
- Age: ${userContext.userAge || 'not specified'}
${brandColors ? `- User's Brand Colors: ${brandColors}` : ""}

=== üî¥ CRITICAL RULES FOR THIS GENERATION (NON-NEGOTIABLE) ===

**üî¥ MANDATORY REQUIREMENTS (EVERY PROMPT MUST HAVE):**

1. **Authentic iPhone Style (MANDATORY):**
   - ‚úÖ **ALWAYS include:** "candid photo" or "candid moment" (prevents plastic/posed look)
   - ‚úÖ **ALWAYS include:** "amateur cellphone photo" or "cellphone photo" (prevents professional look)
   - ‚úÖ **THEN add:** "shot on iPhone 15 Pro portrait mode, shallow depth of field" OR "shot on iPhone, natural bokeh"

**NO BANNED WORDS:** Never use "ultra realistic", "photorealistic", "8K", "4K", "high quality", "perfect", "flawless", "stunning", "beautiful", "gorgeous", "professional photography", "editorial", "magazine quality", "dramatic" (for lighting), "cinematic", "hyper detailed", "sharp focus", "ultra sharp", "crystal clear", "studio lighting", "perfect lighting", "smooth skin", "flawless skin", "airbrushed", "dramatic lighting", "professional yet approachable" - these cause plastic/generic faces and override the user LoRA.

**üî¥ CRITICAL: PROMPT QUALITY CHECKLIST - EVERY PROMPT MUST HAVE:**
1. ‚úÖ Trigger word + ethnicity + gender (no duplicates, format: "${userContext.triggerWord}, ${userContext.userEthnicity ? userContext.userEthnicity + ", " : ""}${userContext.userGender}") - **SKIP for Object/Flatlay/Scenery posts**
2. ‚úÖ Specific outfit description (material + color + garment type - NOT "trendy outfit", stay detailed here)
3. ‚úÖ Simple setting (one-line location, keep brief)
4. ‚úÖ Simple natural lighting (NO dramatic/cinematic terms)
5. ‚úÖ Natural pose/action (NO "striking poses") - **SKIP for Object/Flatlay/Scenery posts**
6. ‚úÖ Authentic iPhone specs: Includes "candid photo" or "candid moment"? Includes "amateur cellphone photo" or "cellphone photo"? "shot on iPhone 15 Pro portrait mode, shallow depth of field" OR "shot on iPhone, natural bokeh"?
7. ‚úÖ Total length: 50-80 words (optimal for LoRA activation)

**Total target: 50-80 words for optimal LoRA activation and accurate character representation**

Return ONLY a JSON array of 9 prompts in this exact format:
[
  { "position": 1, "prompt": "detailed flux prompt here..." },
  { "position": 2, "prompt": "detailed flux prompt here..." },
  ...
  { "position": 9, "prompt": "detailed flux prompt here..." }
]

No other text, no markdown formatting, just the JSON array.`

    // Build user message with all 9 posts
    const userMessage = `Generate enhanced FLUX prompts for all 9 Instagram feed posts.

For each post, follow the exact requirements from the feed strategy and create a detailed, authentic FLUX prompt.

POSTS TO ENHANCE:
${posts.map((post, idx) => `
POST ${post.position}:
- Position: ${post.position} (${Math.floor((post.position - 1) / 3) === 0 ? 'Top Row' : Math.floor((post.position - 1) / 3) === 1 ? 'Middle Row' : 'Bottom Row'})
- Type: ${post.postType}
- Content Pillar: ${post.contentPillar || post.category || 'lifestyle'}
- Story: ${post.storyConcept || post.caption || 'not specified'}
- Value: ${post.valueConcept || 'not specified'}
- Hook: ${post.hookConcept || 'not specified'}
- CTA: ${post.ctaConcept || 'not specified'}
`).join('\n')}

CRITICAL REQUIREMENTS FOR EACH PROMPT:
1. Start with "${userContext.triggerWord}," (SKIP for Object/Flatlay/Scenery posts)
2. Include specific outfit details (material, color, garment type)
3. Include specific location details
4. Include technical specs: "candid photo", "amateur cellphone photo", "shot on iPhone 15 Pro portrait mode, shallow depth of field" OR "shot on iPhone, natural bokeh"
5. Match the post type (portrait/object/flatlay/scenery)
6. NO generic templates - each must be unique and specific
7. 50-80 words per prompt
8. Maintain visual consistency across all 9 posts

Return ONLY a JSON array of 9 prompts in this exact format:
[
  { "position": 1, "prompt": "detailed flux prompt here..." },
  { "position": 2, "prompt": "detailed flux prompt here..." },
  ...
  { "position": 9, "prompt": "detailed flux prompt here..." }
]

No other text, no markdown formatting, just the JSON array.`

    // Call Anthropic API with caching
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-API-Key': process.env.ANTHROPIC_API_KEY!,
        'anthropic-version': '2023-06-01',
        'anthropic-beta': 'prompt-caching-2024-07-31',
      },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514', // Using Sonnet 4 as per Week 1 temporary fix
        max_tokens: 4000, // Enough for all 9 prompts
        system: [
          {
            type: 'text',
            text: systemPrompt,
            cache_control: { type: 'ephemeral' }
          }
        ],
        messages: [
          {
            role: 'user',
            content: userMessage
          }
        ],
        temperature: 0.8,
      })
    })

    if (!response.ok) {
      const errorText = await response.text()
      throw new Error(`Anthropic API error: ${response.status} - ${errorText}`)
    }

    const data = await response.json()
    
    // Log cache usage
    let cacheReadTokens = 0
    if (data.usage) {
      cacheReadTokens = data.usage.cache_read_input_tokens || 0
      console.log('[Maya] [BATCH-FEED-PROMPT] üí∞ Batch generation token usage:', {
        input_tokens: data.usage.input_tokens,
        cache_read: cacheReadTokens,
        output_tokens: data.usage.output_tokens,
      })
    }

    // Extract text from response
    const textContent = data.content
      .filter((c: any) => c.type === 'text')
      .map((c: any) => c.text)
      .join('')

    // Parse JSON response
    const jsonMatch = textContent.match(/\[[\s\S]*\]/)
    if (!jsonMatch) {
      throw new Error('Failed to parse JSON response from AI')
    }

    const prompts: PromptResult[] = JSON.parse(jsonMatch[0])

    // Validate we got all 9
    if (prompts.length !== 9) {
      throw new Error(`Expected 9 prompts, got ${prompts.length}`)
    }

    // Verify each prompt has required trigger word (for user posts)
    prompts.forEach(p => {
      const originalPost = posts.find(op => op.position === p.position)
      const isNonUserPost = originalPost?.postType?.toLowerCase().includes('object') || 
                            originalPost?.postType?.toLowerCase().includes('flatlay') || 
                            originalPost?.postType?.toLowerCase().includes('scenery') || 
                            originalPost?.postType?.toLowerCase().includes('place')

      if (!isNonUserPost && !p.prompt.toLowerCase().startsWith(userContext.triggerWord.toLowerCase())) {
        console.warn(`[Maya] [BATCH-FEED-PROMPT] ‚ö†Ô∏è Prompt for position ${p.position} missing trigger word, fixing...`)
        p.prompt = `${userContext.triggerWord}, ${p.prompt}`
      } else if (isNonUserPost && p.prompt.toLowerCase().startsWith(userContext.triggerWord.toLowerCase())) {
        console.warn(`[Maya] [BATCH-FEED-PROMPT] ‚ö†Ô∏è Non-user post for position ${p.position} incorrectly includes trigger word, fixing...`)
        p.prompt = p.prompt.replace(new RegExp(`^${userContext.triggerWord},?\\s*`, 'i'), '').trim()
      }
      // Clean up any duplicate trigger words or leading commas
      p.prompt = p.prompt.replace(new RegExp(`^${userContext.triggerWord},?\\s*${userContext.triggerWord}`, 'i'), userContext.triggerWord).replace(/^,\s*/, '').trim()
    })

    return {
      success: true,
      prompts: prompts,
      tokenUsage: data.usage,
    }

  } catch (error: any) {
    console.error('[Maya] [BATCH-FEED-PROMPT] Error generating batch prompts:', error)
    return {
      success: false,
      prompts: [],
      error: error.message || 'Failed to generate prompts'
    }
  }
}

