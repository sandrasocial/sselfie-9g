# Maya Pro Mode Prompting Pipeline Analysis

## Problem Statement
- Concepts #2-6 have identical/similar prompts (not using Maya's intelligence)
- All concept titles and descriptions are boring and repetitive
- Maya is not using her personality, fashion intelligence, or eye for details
- Hardcoded templates are overriding Maya's creative intelligence

## Root Cause Analysis

### 1. **Composition System Override**
**Location:** `app/api/maya/generate-concepts/route.ts:3261-3359`

The system uses a **composition system** that builds concepts from hardcoded components instead of letting Maya generate them creatively:

```typescript
// Line 3292-3298: Composition system generates concepts
const composed = compositionBuilder.composePrompt({
  category: categoryForComposition,
  userIntent: userRequest || context || aesthetic || '',
  brand: detectedBrandValue,
  count: composedConcepts.length,
  previousConcepts: composedComponents,
})
```

**Problem:** This system:
- Uses pre-built components (outfit, pose, location, lighting)
- Generates generic titles like "Concept 1", "Concept 2"
- Doesn't use Maya's personality or storytelling ability
- Creates boring, template-like descriptions

**Evidence:**
- Line 3326-3332: Uses upload module category/concept for titles (generic "Beauty Concept 1")
- Line 3336-3344: Titles come from `composed.title` which is generic, not from Maya

### 2. **Massive System Prompt Overload**
**Location:** `app/api/maya/generate-concepts/route.ts:1748-3114`

The system prompt sent to Claude is **MASSIVE** (over 1300 lines!) and includes:
- 30+ template examples
- Hundreds of rules and restrictions
- Scandinavian minimalism defaults
- Brand library requirements
- Hardcoded prompt structures
- Multiple conflicting instructions

**Problem:** Maya's personality and intelligence get buried under:
- Template examples that force her to copy structure
- Rules that prevent creativity
- Defaults that override her fashion knowledge
- Hardcoded outfit/pose templates

**Evidence:**
- Line 2136-2174: Template examples with "ABSOLUTE REQUIREMENTS" to copy structure
- Line 2484-2529: Brand library forces specific brand names
- Line 2539-2620: Hardcoded prompt structure architecture

### 3. **Missing Maya Personality in Concept Generation**
**Location:** `app/api/maya/generate-concepts/route.ts:1741-1745`

Maya's personality is included in the prompt, BUT:
- It's buried under 1300+ lines of rules
- Template examples override personality instructions
- Composition system bypasses personality entirely

**Evidence:**
- Line 1741-1745: Personality section is small compared to rules
- Line 718-777 in `lib/maya/direct-prompt-generation.ts`: Title/description storytelling instructions exist but are ignored when composition system is used

### 4. **AI Fallback Uses Same Problematic Prompt**
**Location:** `app/api/maya/generate-concepts/route.ts:3368-3405`

When composition system doesn't produce enough concepts, it falls back to AI generation using the same massive system prompt with all the template overload.

### 5. **Consistency Mode Uses Same Composition System**
**Location:** `app/api/maya/generate-concepts/route.ts:4237-4407`

The reference image consistency logic we just fixed works correctly, BUT:
- It still uses concepts generated by the composition system
- Concepts #2-6 come from composition system (boring, repetitive)
- Only the prompts are enhanced for reference images

## Recommended Solutions

### Solution 1: Disable Composition System (Quick Fix)
**File:** `app/api/maya/generate-concepts/route.ts`

**Change:** Force AI generation instead of composition system:
```typescript
// Line 3261: Change this condition
const hasEnoughComponents = false // Force AI generation
// OR
if (false) { // Skip composition system entirely
```

This will force all concepts to be generated by Maya using her personality.

### Solution 2: Simplify System Prompt (Better Fix)
**File:** `app/api/maya/generate-concepts/route.ts`

**Changes:**
1. Remove template examples (lines 2136-2174)
2. Reduce hardcoded rules
3. Trust Maya's personality to generate creative concepts
4. Keep only essential instructions (reference images, trigger words, camera specs)

**Keep:**
- Maya's personality section
- Reference image instructions
- Essential technical requirements

**Remove:**
- Template examples (too prescriptive)
- Hardcoded prompt structures
- Brand library requirements (let Maya choose)
- Scandinavian defaults (let Maya decide)

### Solution 3: Use Direct Prompt Generation Feature Flag
**File:** `app/api/maya/generate-concepts/route.ts`

**Status:** Feature flag exists but is disabled by default

**Enable:** Set `USE_DIRECT_PROMPT_GENERATION=true` in environment

This uses `generateConceptsWithFinalPrompts` from `lib/maya/direct-prompt-generation.ts` which:
- Has better storytelling instructions (lines 718-777)
- Simpler system prompt
- More creative titles/descriptions

### Solution 4: Fix Title/Description Generation in Composition System
**File:** `app/api/maya/generate-concepts/route.ts`

**Change:** Instead of using `composed.title` and `composed.description`, call Maya to generate creative titles/descriptions:

```typescript
// After line 3335, before creating concept:
const { text: creativeContent } = await generateText({
  model: 'anthropic/claude-sonnet-4-20250514',
  messages: [{
    role: 'user',
    content: `Generate a creative, story-driven title and description for this concept: ${composed.prompt}`
  }],
  temperature: 0.9
})
```

## Immediate Action Plan

1. **Quick Test:** Disable composition system to see if Maya generates better concepts
2. **Medium Fix:** Enable `USE_DIRECT_PROMPT_GENERATION` feature flag
3. **Better Fix:** Simplify system prompt by removing template examples and hardcoded rules
4. **Best Fix:** Redesign concept generation to always use Maya's personality and storytelling

## Files to Modify

1. `app/api/maya/generate-concepts/route.ts`
   - Line 3261: Disable composition system
   - Line 2136-2174: Remove template examples section
   - Line 1748-3114: Simplify system prompt
   
2. `.env.local` (if using Solution 3)
   - Add: `USE_DIRECT_PROMPT_GENERATION=true`

3. `lib/maya/direct-prompt-generation.ts` (if enhancing)
   - Already has good storytelling instructions
   - May need minor tweaks

## Success Criteria

After fixes:
- ✅ Concepts #2-6 have unique, creative titles (not "Concept 2", "Concept 3")
- ✅ Descriptions tell stories (not generic "woman in outfit at location")
- ✅ Maya uses her fashion intelligence (not hardcoded templates)
- ✅ Each concept feels unique and creative
- ✅ Prompts vary meaningfully across concepts #2-6


