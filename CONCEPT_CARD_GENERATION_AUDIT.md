# Comprehensive Audit: Concept Card Generation, Storage, and Display Flow

## Executive Summary

This audit identifies **WHERE and WHY** Maya's creative output (prompts, descriptions, titles) is being modified after generation. The investigation reveals multiple points where concept data is altered between Maya's generation and final display/storage.

---

## PART 1: CONCEPT GENERATION FLOW

### Classic Mode: `app/api/maya/generate-concepts/route.ts`

#### 1.1 Maya Generates Concepts
**Location:** Lines 2663-2702

```2663:2702:app/api/maya/generate-concepts/route.ts
    const { text } = await generateText({
      model: 'anthropic/claude-sonnet-4-20250514',
      messages: [
        {
          role: 'user',
          content: conceptPrompt,
        },
      ],
      temperature: 0.85,
    })

    console.log('[v0] Generated concept text (first 300 chars):', text.substring(0, 300))

    // Parse JSON response
    let concepts: MayaConcept[] = []
    const jsonMatch = text.match(/\[[\s\S]*\]/)
    if (jsonMatch) {
      concepts = JSON.parse(jsonMatch[0])
      
      // üî¥ CRITICAL: Update titles/descriptions with upload module category/concept if available
      const uploadModuleCategoryForAI = (referenceImages as any)?.category
      const uploadModuleConceptForAI = (referenceImages as any)?.concept
      
      if (uploadModuleCategoryForAI && uploadModuleConceptForAI) {
        concepts.forEach((concept, index) => {
          const categoryTitle = uploadModuleCategoryForAI.charAt(0).toUpperCase() + uploadModuleCategoryForAI.slice(1)
          const conceptTitlePart = uploadModuleConceptForAI.charAt(0).toUpperCase() + uploadModuleConceptForAI.slice(1)
          concept.title = `${categoryTitle} - ${conceptTitlePart} ${index + 1}`
          concept.description = `${uploadModuleCategoryForAI} ${uploadModuleConceptForAI} concept with detailed specifications`
          concept.category = uploadModuleCategoryForAI
          console.log("[v0] [AI-GENERATION] ‚úÖ Updated concept title with upload module category:", concept.title)
        })
      }
```

**üî¥ ISSUE #1: Upload Module Override**
- **Lines 2687-2694:** Upload module category/concept **OVERRIDES** Maya's generated titles and descriptions
- Maya's creative titles are replaced with generic format: `"Category - Concept 1"`
- Maya's detailed descriptions are replaced with: `"category concept concept with detailed specifications"`

#### 1.2 Prompt Generation (Direct Generation)
**Location:** Lines 2718-2746

```2718:2746:app/api/maya/generate-concepts/route.ts
    // Direct Prompt Generation - generate final prompts for all concepts
    if (concepts.length > 0) {
      for (let i = 0; i < concepts.length; i++) {
        const concept = concepts[i]
        
        try {
          const result = await generatePromptDirect({
            userRequest: concept.description || userRequest || '',
            category: concept.category,
            conceptIndex: i,
            triggerWord: triggerWord || '',
            gender: userGender || 'woman',
            ethnicity: userEthnicity || undefined,
            physicalPreferences: physicalPreferences || undefined,
            mode: studioProMode ? 'pro' : 'classic',
            referenceImages: referenceImages,
            conversationContext: conversationContext
          })
          
          // Set prompt
          concept.prompt = result.prompt
        } catch (error) {
          console.error(`[v0] [DIRECT] Error generating prompt for concept ${i + 1}:`, error)
          
          // Fallback: Use description as prompt if direct generation fails
          concept.prompt = `${triggerWord || ''}, ${concept.description || ''}`.trim()
        }
      }
    }
```

**üî¥ ISSUE #2: Prompt Built from Description**
- Maya generates `title` and `description`
- **Prompt is NOT generated by Maya** - it's built by `generatePromptDirect()` using the description
- If description was overridden by upload module, the prompt will be based on the generic description, not Maya's original

#### 1.3 Extensive Post-Processing
**Location:** Lines 4000-4207

**üî¥ ISSUE #3: Massive Post-Processing Modifications**

The code performs extensive modifications to prompts after generation:

1. **Skin Texture Handling** (Lines 4000-4028)
   - Removes "with visible pores" from end
   - Adds "natural skin texture with visible pores" in specific locations
   - Modifies based on Studio Pro mode

2. **iPhone Specs Enforcement** (Lines 4082-4136)
   - Removes duplicate iPhone mentions
   - Adds iPhone specs if missing
   - Replaces focal length with iPhone specs
   - Modifies based on Enhanced Authenticity toggle

3. **Candid/Amateur Keywords** (Lines 4138-4174)
   - Adds "candid photo" or "candid moment" if missing
   - Adds "amateur cellphone photo" if missing
   - Modifies based on Enhanced Authenticity toggle

4. **Anti-Plastic Validation** (Lines 4176-4183)
   - Calls `ensureRequiredElements()` which adds more modifications
   - Skips for Studio Pro mode and guide prompts

5. **Lighting Modifications** (Lines 4048-4069)
   - Replaces "uneven lighting" with "studio lighting" if requested
   - Replaces "uneven lighting" with "natural lighting with realistic shadows" for professional requests
   - Removes studio lighting if not requested

6. **Final Cleanup** (Lines 4189-4198)
   - Calls `minimalCleanup()` for syntax fixes
   - Removes double commas, normalizes whitespace

**Result:** Maya's original prompt is heavily modified before being saved/displayed.

---

### Pro Mode: `app/api/maya/pro/generate-concepts/route.ts`

#### 2.1 Maya Generates Concepts
**Location:** Lines 522-550

```522:550:app/api/maya/pro/generate-concepts/route.ts
    try {
      const { text } = await generateText({
        model: "anthropic/claude-sonnet-4-20250514",
        prompt: aiPrompt,
        temperature: 0.85,
      })

      // Parse AI response
      const jsonMatch = text.match(/\[[\s\S]*\]/)
      if (!jsonMatch) {
        console.error("[v0] [PRO MODE] No JSON array found in AI response. Response text:", text.substring(0, 500))
        throw new Error("No JSON array found in AI response")
      }

      let aiConcepts: any[]
      try {
        aiConcepts = JSON.parse(jsonMatch[0])
      } catch (parseError: any) {
        console.error("[v0] [PRO MODE] JSON parse error:", parseError)
        console.error("[v0] [PRO MODE] JSON string that failed to parse:", jsonMatch[0].substring(0, 500))
        throw new Error(`Failed to parse AI response as JSON: ${parseError.message}`)
      }
      
      // üî¥ DEBUG: Log what Maya generated
      console.log('[v0] [PRO MODE] Maya generated concepts:', aiConcepts.map((c: any) => ({
        title: c.title?.substring(0, 50),
        description: c.description?.substring(0, 100),
        category: c.category,
      })))
```

**‚úÖ GOOD:** Pro Mode logs what Maya generates before modifications.

#### 2.2 Prompt Generation (Direct Generation)
**Location:** Lines 638-668

```638:668:app/api/maya/pro/generate-concepts/route.ts
          try {
            const { generatePromptDirect } = await import('@/lib/maya/direct-prompt-generation')
            
            // üî¥ CRITICAL: Pass the CONCEPT DESCRIPTION, not the original userRequest!
            // The description contains all the specific details (brands, items, settings) that Maya needs
            const directResult = await generatePromptDirect({
              userRequest: safeDescription, // Use concept description with all specific details
              category: safeCategory || undefined,
              conceptIndex: index,
              triggerWord: '', // Pro mode doesn't use trigger words
              gender: 'woman', // TODO: Get from user profile
              ethnicity: undefined,
              physicalPreferences: undefined,
              mode: 'pro'
            })
            
            fullPrompt = directResult.prompt
            finalCategory = promptCategory
            
            // üî¥ DEBUG: Log the generated prompt
            console.log(`[v0] [PRO MODE] Generated prompt for concept ${index + 1} (first 200 chars):`, fullPrompt.substring(0, 200))
            console.log(`[v0] [PRO MODE] Final category for concept ${index + 1}:`, finalCategory)
          } catch (directError: any) {
            console.error(`[v0] [PRO MODE] Error in direct generation for concept ${index + 1}:`, directError)
            // Fallback to basic prompt if direct generation fails
            fullPrompt = `Professional photography. ${safeTitle}. ${safeDescription}. Shot on iPhone 15 Pro portrait mode, shallow depth of field, natural skin texture with pores visible, film grain, muted colors, authentic iPhone photo aesthetic.`
          }
```

**üî¥ ISSUE #4: Prompt Built from Description**
- Same as Classic Mode: prompt is built from description, not generated by Maya
- Uses `generatePromptDirect()` which transforms the description into a structured prompt

#### 2.3 Description Validation & Enhancement
**Location:** Lines 583-613

```583:613:app/api/maya/pro/generate-concepts/route.ts
          // üî¥ VALIDATION: Ensure description is detailed enough
          const descriptionWordCount = safeDescription.split(/\s+/).length
          const hasBrandMention = /alo|lululemon|glossier|chanel|dior|bottega|everlane|reformation|aritzia|the row|jenni kayne|levi|zara|cos|rhode|herm√®s/i.test(safeDescription)
          const hasSpecificDetails = /wearing|sitting|standing|holding|looking|marble|fireplace|tree|light|sweater|denim|dress|blazer|coat|jacket|sofa|mug|room|interior|outfit|attire/i.test(safeDescription)

          if (descriptionWordCount < 20 || !hasSpecificDetails) {
            console.warn(`[v0] [VALIDATION] Description too vague for concept ${index + 1}:`, safeDescription)
            console.warn(`[v0] [VALIDATION] Word count: ${descriptionWordCount}, Has brands: ${hasBrandMention}, Has details: ${hasSpecificDetails}`)
            
            // Try to enhance description from other available fields in aiConcept
            const extractedDetails: string[] = []
            
            // Extract details from aesthetic field if available
            if (safeAesthetic && safeAesthetic.length > 20) {
              // Use aesthetic as additional context
              extractedDetails.push(safeAesthetic)
            }
            
            // Extract details from title if it's descriptive
            if (safeTitle && safeTitle.length > 15 && /sitting|wearing|standing|holding|cozy|elegant|sophisticated/i.test(safeTitle)) {
              extractedDetails.push(safeTitle)
            }
            
            // Enhance description if we found additional details
            if (extractedDetails.length > 0) {
              const enhancedDescription = `${safeDescription} ${extractedDetails.join(', ')}.`
              console.log(`[v0] [VALIDATION] Enhanced description for concept ${index + 1} with details from aesthetic/title`)
              // Note: We'll use the enhanced description, but this is a fallback
              // The AI should ideally generate detailed descriptions from the start
            }
          }
```

**üî¥ ISSUE #5: Description Enhancement**
- If description is too vague, code tries to enhance it from aesthetic/title fields
- However, the enhanced description is logged but **NOT actually used** (line 612 comment says "Note: We'll use the enhanced description, but this is a fallback")
- This means vague descriptions may still be used for prompt generation

---

## PART 2: PROMPT BUILDING & MODIFICATION

### Direct Prompt Generation: `lib/maya/direct-prompt-generation.ts`

#### 2.1 System Prompt Building
**Location:** Lines 104-225

```104:225:lib/maya/direct-prompt-generation.ts
function buildSystemPromptWithExamples(context: DirectPromptContext): string {
  
  const { mode } = context
  
  if (mode === 'classic') {
    return buildClassicSystemPrompt(context)
  } else {
    return buildProSystemPrompt(context)
  }
}

/**
 * CLASSIC MODE SYSTEM PROMPT
 */
function buildClassicSystemPrompt(context: DirectPromptContext): string {
  
  const { triggerWord, gender, ethnicity, physicalPreferences } = context
  
  return `Generate a FINAL IMAGE GENERATION PROMPT for Flux (Classic Mode).

**REQUIREMENTS:**
- Format: Natural language, 30-60 words
- Structure: [trigger], [person], [outfit], [pose/action], [location], [lighting], camera specs
- Must start with "${triggerWord}" (first word)
- Person: ${ethnicity ? ethnicity + ' ' : ''}${gender}${physicalPreferences ? ', ' + physicalPreferences : ''}
- Always end with: "shot on iPhone 15 Pro portrait mode, candid photo, natural skin texture with pores visible, film grain, muted colors"

**EXAMPLES:**

Example 1 (45 words):
"${triggerWord}, White woman, long dark hair in ponytail, cream tank top, black Lululemon belt bag, standing at mountain summit with valley view, natural hiking light, shot on iPhone 15 Pro portrait mode, candid photo, natural skin texture with pores visible, film grain, muted colors"

Example 2 (42 words):
"${triggerWord}, Asian woman, shoulder-length black hair, oversized beige sweater, sitting at cafe table with latte, soft window lighting, shot on iPhone 15 Pro portrait mode, candid photo, natural skin texture with pores visible, film grain, muted colors"

**SELFIE HANDLING:**
If the description mentions "selfie", "front camera selfie", "mirror selfie", or selfie-related framing:
- Replace "shot on iPhone 15 Pro portrait mode" with "ultra-realistic iPhone 15 Pro front camera selfie" or "iPhone 15 Pro mirror selfie reflection"
- Add selfie-specific details like "arm extended holding phone" or "mirror visible in frame"
- Maintain same quality and authentic aesthetic

**AVOID:**
- Structured sections (no "POSE:", "OUTFIT:", etc.)
- Exceeding 60 words
- Redundant descriptors
- Forgetting the trigger word

Generate ONE prompt (30-60 words) in the style above.`
}

/**
 * PRO MODE SYSTEM PROMPT
 */
function buildProSystemPrompt(context: DirectPromptContext): string {
  
  const { userRequest, conceptIndex } = context
  
  // Determine camera style
  const isEditorial = conceptIndex !== undefined && conceptIndex < 3
  
  return `Transform this DESCRIPTION into a structured prompt. Preserve EVERY specific detail.

**WORD COUNT:** Target 100-200 words total (structured format with multiple sections)

**CRITICAL RULES:**
1. Copy brands/products EXACTLY (The Row ‚Üí "The Row", not "luxury brand")
2. No vague language ("elegant sweater" ‚Üí "The Row cream cashmere turtleneck")
3. No OR statements (if description says ONE item, write ONE item)
4. Include ALL brands/items mentioned in description
5. Complete sentences only (no fragments)

**DESCRIPTION:**
"""
${userRequest || 'No description provided'}
"""

**BAG RULES:**
‚úÖ Include bag if: person is walking/moving, traveling, shopping, or in editorial scene
‚ùå Don't include bag if: person is sitting at home, relaxing, in domestic setting, or doing activities where bag would be awkward

**FORMAT:**

${isEditorial 
  ? 'Professional photography. Pinterest-style editorial portrait.' 
  : 'Authentic influencer content. Pinterest-style portrait.'
} Character consistency with provided reference images. Match the exact facial features, hair, skin tone, body type, and physical characteristics of the person in the reference images. This is the same person in a different scene. ${isEditorial ? 'Editorial quality, professional photography aesthetic.' : 'Natural, relatable iPhone aesthetic.'}

**Outfit:** [EXACT outfit from description - all brands, all pieces, all materials. Example: "The Row cream cashmere turtleneck sweater, Brunello Cucinelli camel wide-leg trousers, Cartier watch"]

**Pose:** [EXACT action from description. Example: "Gracefully sitting on ivory velvet sofa beside Fraser fir Christmas tree, holding fine bone china teacup with both hands, gazing thoughtfully at fireplace"]

**Setting:** [ALL specific items from description. Example: "Living room with ivory velvet sofa, Fraser fir Christmas tree with crystal ornaments and warm white lights, floor-to-ceiling windows, wrapped Herm√®s boxes beneath tree, white orchids on side table"]

**Lighting:** [EXACT lighting from description. Example: "Golden fireplace glow mixed with natural winter light from windows, creating serene luxury atmosphere"]

**Camera Composition:** 
${isEditorial 
  ? 'Editorial portrait from mid-thigh upward, frontal camera position, symmetrical centered framing, professional DSLR, Canon EOS R5 or Sony A7R IV, 85mm f/1.4 lens, camera distance 1.5-2m from subject, shallow depth of field (f/2.0-f/2.8).'
  : 'Authentic iPhone 15 Pro portrait mode, 77mm equivalent, natural bokeh effect, shot from 1.5m distance, portrait mode depth creating soft background blur, influencer content aesthetic.'
}

**Mood:** [Mood words from description. Example: "Serene, luxurious, elegant holiday morning"]

**Aesthetic:** [Aesthetic from description with Pinterest language. Example: "Luxurious holiday morning elegance, sophisticated Christmas styling, aspirational holiday luxury"]

**SELFIE HANDLING:**
If the description mentions "selfie", "front camera selfie", "mirror selfie", or similar selfie framing:
- Use iPhone front camera specifications (not DSLR)
- Include selfie-specific framing details (arm extended, mirror reflection, etc.)
- Maintain same quality and luxury as professional concepts
- Use "iPhone 15 Pro front camera selfie" or "iPhone 15 Pro mirror selfie" in Camera Composition section

**VERIFY BEFORE SUBMITTING:**
‚úÖ Every brand in description appears in prompt?
‚úÖ No vague words replacing specific items?
‚úÖ No OR statements?
‚úÖ All sentences complete?
‚úÖ Bag only if contextually appropriate?
‚úÖ Selfie descriptions use iPhone front camera (not DSLR)?

Transform the description above into the structured format.`
}
```

**üî¥ ISSUE #6: Prompt Transformation**
- Maya generates a **description**, not a prompt
- `generatePromptDirect()` transforms the description into a structured prompt
- The transformation follows strict rules and examples
- **Maya's original creative language may be lost** in the transformation

#### 2.2 Programmatic Fixes
**Location:** Lines 269-300

```269:300:lib/maya/direct-prompt-generation.ts
export function applyProgrammaticFixes(
  prompt: string,
  context: DirectPromptContext
): string {
  
  let fixed = prompt.trim()
  
  // Ensure trigger word is first (Classic mode only)
  if (context.mode === 'classic') {
    const promptLower = fixed.toLowerCase()
    const triggerLower = context.triggerWord.toLowerCase()
    
    if (!promptLower.startsWith(triggerLower)) {
      fixed = `${context.triggerWord}, ${fixed}`
    }
  }
  
  // Enforce camera style based on conceptIndex (Pro mode)
  if (context.mode === 'pro' && context.conceptIndex !== undefined) {
    const shouldBeDSLR = context.conceptIndex < 3
    const hasDSLR = /professional DSLR|Canon EOS|Sony A7|85mm f\/1\.[24]/i.test(fixed)
    const hasIPhone = /iPhone.*Pro.*portrait mode/i.test(fixed)
    
    if (shouldBeDSLR && hasIPhone && !hasDSLR) {
      fixed = fixed.replace(/iPhone 15 Pro.*?portrait mode/gi, 'professional DSLR, Canon EOS R5, 85mm f/1.4 lens')
    } else if (!shouldBeDSLR && hasDSLR && !hasIPhone) {
      fixed = fixed.replace(/professional DSLR.*?(?:Canon|Sony).*?(?:85mm|50mm)/gi, 'iPhone 15 Pro portrait mode')
    }
  }
  
  // Normalize whitespace
  fixed = fixed.replace(/\s+/g, ' ').trim()
  
  return fixed
}
```

**üî¥ ISSUE #7: Camera Spec Override**
- Pro Mode: Camera specs are **forced** based on conceptIndex
- Concepts 0-2: Forced to DSLR (even if Maya specified iPhone)
- Concepts 3-5: Forced to iPhone (even if Maya specified DSLR)
- **Maya's camera choice is overridden**

---

## PART 3: CONCEPT STORAGE

### Database Schema

**Location:** `scripts/04-create-photo-tables.sql` and `scripts/00-create-all-tables.sql`

```24:38:scripts/04-create-photo-tables.sql
-- Concept cards (photo ideas from Maya)
CREATE TABLE IF NOT EXISTS concept_cards (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  chat_id UUID REFERENCES maya_chats(id) ON DELETE SET NULL,
  title TEXT NOT NULL,
  description TEXT,
  prompt TEXT NOT NULL,
  negative_prompt TEXT,
  aesthetic_recipe TEXT,
  reference_image_url TEXT,
  status TEXT DEFAULT 'draft' CHECK (status IN ('draft', 'generated', 'archived')),
  metadata JSONB DEFAULT '{}',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**Fields Stored:**
- `title`: Maya's title (may be overridden by upload module)
- `description`: Maya's description (may be overridden by upload module)
- `prompt`: **Generated by `generatePromptDirect()`, not Maya**

### Storage Location: `lib/data/maya.ts`

**Location:** Lines 224-226

```224:226:lib/data/maya.ts
        INSERT INTO maya_chat_messages (chat_id, role, content, concept_cards)
        VALUES (${chatId}, ${role}, ${safeContent}, ${conceptCards ? JSON.stringify(conceptCards) : null})
        RETURNING *
```

**üî¥ ISSUE #8: JSON Storage**
- Concepts are stored as JSON in `maya_chat_messages.concept_cards`
- The JSON contains the **modified** concepts (after all post-processing)
- Maya's original output is **not preserved**

---

## PART 4: CONCEPT DISPLAY (UI)

### Component: `components/sselfie/concept-card.tsx`

**Location:** Lines 1119-1124

```1119:1124:components/sselfie/concept-card.tsx
        <div className="space-y-2">
          <p className="text-sm leading-relaxed text-stone-950 font-serif font-light">
            {concept.title}
          </p>
          <p className="text-xs leading-relaxed text-stone-600 font-light line-clamp-2">{concept.description}</p>
        </div>
```

**Display Fields:**
- `concept.title`: Displayed as-is (may be overridden)
- `concept.description`: Displayed as-is (may be overridden)
- `concept.prompt`: Not displayed directly, but used for generation

**üî¥ ISSUE #9: No Original Data Display**
- UI displays the modified title/description
- No way to see Maya's original output
- User cannot tell if data was modified

### Prompt Editor (Pro Mode Only)

**Location:** Lines 1442-1530

```1474:1474:components/sselfie/concept-card.tsx
                    value={editedPrompt ?? concept.prompt ?? `${concept.title}: ${concept.description}`}
```

**üî¥ ISSUE #10: Prompt Editor Uses Modified Prompt**
- Prompt editor shows `concept.prompt` (the generated/modified prompt)
- User can edit it, but original Maya prompt is not shown
- Line 1487-1503 shows "Original Maya Prompt" but it's actually the generated prompt, not Maya's original

---

## PART 5: REPLICATE INTEGRATION

### Classic Mode: `app/api/maya/generate-image/route.ts`

**Location:** Lines 255-333

```255:333:app/api/maya/generate-image/route.ts
    // =============================================================================
    // PROMPT QUALITY VALIDATION & FALLBACK
    // =============================================================================
    // Validate Maya's prompt quality before using it
    // If quality checks fail, rebuild using buildClassicPrompt for guaranteed quality
    
    const wordCount = conceptPrompt.split(/\s+/).length
    const hasIphoneSpecs = /iphone.*pro|portrait mode/i.test(conceptPrompt)
    const hasAuthenticityMarkers = /candid|natural.*texture|film grain|muted colors/i.test(conceptPrompt)
    
    let finalPrompt: string
    let promptRebuilt = false
    
    if (wordCount < 20 || wordCount > 80 || !hasIphoneSpecs || !hasAuthenticityMarkers) {
      // Quality checks failed - rebuild with buildClassicPrompt
      console.log("[v0] [PROMPT-VALIDATION] Maya's prompt failed quality checks, rebuilding with buildClassicPrompt", {
        wordCount,
        hasIphoneSpecs,
        hasAuthenticityMarkers
      })
      
      // Extract elements from Maya's prompt
      const extractedOutfit = extractOutfit(conceptPrompt)
      const extractedLocation = extractLocation(conceptPrompt)
      const extractedPose = extractPose(conceptPrompt)
      const extractedMood = extractMood(conceptPrompt)
      const extractedLighting = extractLighting(conceptPrompt)
      
      // Build context for buildClassicPrompt
      const context: ClassicPromptContext = {
        triggerWord,
        userGender: genderTerm,
        userEthnicity: ethnicity && ethnicity !== 'Other' ? ethnicity : undefined,
        physicalPreferences: undefined, // Not available in request, could be extracted if needed
        outfit: extractedOutfit || 'styled outfit',
        location: extractedLocation || 'elegant setting',
        lighting: extractedLighting || 'natural lighting',
        pose: extractedPose || 'natural pose',
        mood: extractedMood,
        photographyStyle: enhancedAuthenticity ? 'authentic' : undefined
      }
      
      // Rebuild prompt using buildClassicPrompt
      const result = buildClassicPrompt(context)
      
      // Log metadata for debugging
      console.log('[v0] [PROMPT-VALIDATION] Rebuilt prompt metadata:', {
        wordCount: result.wordCount,
        validated: result.validated,
        warnings: result.warnings
      })
      
      // Use the rebuilt prompt
      finalPrompt = result.prompt
      promptRebuilt = true
      
      // Log validation warnings if any
      if (!result.validated) {
        console.error('[v0] [PROMPT-VALIDATION] Rebuilt prompt failed validation, but continuing with prompt')
      }
    } else {
      // Quality checks passed - use Maya's creative prompt (fast path)
      console.log("[v0] [PROMPT-VALIDATION] Maya's prompt passed quality checks, using directly", {
        wordCount,
        hasIphoneSpecs,
        hasAuthenticityMarkers
      })
      
      finalPrompt = conceptPrompt
      
      // Ensure trigger word is at the start
      const promptLower = finalPrompt.toLowerCase().trim()
      const triggerLower = triggerWord.toLowerCase()
      
      if (!promptLower.startsWith(triggerLower)) {
        finalPrompt = `${triggerWord}, ${finalPrompt}`
      }
    }
```

**üî¥ ISSUE #11: Prompt Rebuilding at Generation Time**
- Even after all modifications, the prompt can be **rebuilt again** at generation time
- If quality checks fail, `buildClassicPrompt()` is called to rebuild from extracted elements
- **Maya's original prompt may be completely replaced** at this stage

### Pro Mode: `app/api/maya/generate-studio-pro/route.ts`

**Location:** Lines 55-83

```55:83:app/api/maya/generate-studio-pro/route.ts
    // BUILD optimized Nano Banana prompt
    let optimizedPrompt: string
    let sceneDescription: string
    try {
      const result = await buildNanoBananaPrompt({
        userId: neonUserId,
        mode: mode as any,
        userRequest,
        inputImages: inputImages || {},
      })
      optimizedPrompt = result.optimizedPrompt
      sceneDescription = result.sceneDescription
      console.log("[STUDIO-PRO] Prompt built successfully:", {
        promptLength: optimizedPrompt.length,
        sceneDescription
      })
    } catch (promptError) {
      console.error("[STUDIO-PRO] Failed to build prompt:", promptError)
      const errorDetails = promptError instanceof Error ? promptError.message : String(promptError)
      const errorStack = promptError instanceof Error ? promptError.stack : undefined
      console.error("[STUDIO-PRO] Error details:", { errorDetails, errorStack })
      return NextResponse.json(
        { 
          error: "Failed to build generation prompt",
          details: errorDetails
        },
        { status: 500 }
      )
    }
```

**üî¥ ISSUE #12: Pro Mode Prompt Rebuilding**
- Pro Mode calls `buildNanoBananaPrompt()` which processes the prompt again
- The `userRequest` parameter is `concept.prompt` (from concept card)
- This prompt has already been modified by `generatePromptDirect()`
- **Another transformation happens here**

---

## PART 6: SEARCH FOR MODIFICATIONS

### All Places Where Concept Data is Modified

1. **Upload Module Override** (Classic Mode)
   - **File:** `app/api/maya/generate-concepts/route.ts`
   - **Lines:** 2687-2694
   - **Modifies:** `concept.title`, `concept.description`, `concept.category`
   - **Impact:** HIGH - Replaces Maya's creative titles/descriptions with generic format

2. **Direct Prompt Generation** (Both Modes)
   - **File:** `lib/maya/direct-prompt-generation.ts`
   - **Lines:** 44-99
   - **Modifies:** `concept.prompt` (generates from description)
   - **Impact:** HIGH - Maya doesn't generate prompts, they're built from descriptions

3. **Post-Processing** (Classic Mode)
   - **File:** `app/api/maya/generate-concepts/route.ts`
   - **Lines:** 4000-4207
   - **Modifies:** `concept.prompt` (extensive modifications)
   - **Impact:** CRITICAL - Heavily modifies prompts after generation

4. **Description Enhancement** (Pro Mode)
   - **File:** `app/api/maya/pro/generate-concepts/route.ts`
   - **Lines:** 583-613
   - **Modifies:** `concept.description` (enhancement attempted but not applied)
   - **Impact:** MEDIUM - Enhancement is logged but not used

5. **Camera Spec Override** (Pro Mode)
   - **File:** `lib/maya/direct-prompt-generation.ts`
   - **Lines:** 287-297
   - **Modifies:** `concept.prompt` (forces camera specs)
   - **Impact:** MEDIUM - Overrides Maya's camera choice

6. **Prompt Rebuilding** (Classic Mode at Generation)
   - **File:** `app/api/maya/generate-image/route.ts`
   - **Lines:** 268-333
   - **Modifies:** `finalPrompt` (rebuilds if quality checks fail)
   - **Impact:** HIGH - Can completely replace prompt at generation time

7. **Nano Banana Prompt Building** (Pro Mode at Generation)
   - **File:** `app/api/maya/generate-studio-pro/route.ts`
   - **Lines:** 59-66
   - **Modifies:** `optimizedPrompt` (transforms prompt again)
   - **Impact:** MEDIUM - Another transformation layer

---

## SUMMARY: FLOW DIAGRAMS

### Classic Mode Flow

```
1. Maya generates concepts
   ‚îú‚îÄ title: "Christmas Morning Cozy"
   ‚îú‚îÄ description: "Cozy holiday morning moment..."
   ‚îî‚îÄ category: "Lifestyle"

2. Upload Module Override (if applicable)
   ‚îú‚îÄ title: "Category - Concept 1" ‚ùå OVERRIDDEN
   ‚îú‚îÄ description: "category concept concept..." ‚ùå OVERRIDDEN
   ‚îî‚îÄ category: "category" ‚ùå OVERRIDDEN

3. Direct Prompt Generation
   ‚îú‚îÄ Input: concept.description (may be overridden)
   ‚îú‚îÄ Process: generatePromptDirect()
   ‚îî‚îÄ Output: concept.prompt (structured prompt)

4. Post-Processing (Lines 4000-4207)
   ‚îú‚îÄ Skin texture handling
   ‚îú‚îÄ iPhone specs enforcement
   ‚îú‚îÄ Candid/amateur keywords
   ‚îú‚îÄ Anti-plastic validation
   ‚îú‚îÄ Lighting modifications
   ‚îî‚îÄ Final cleanup
   ‚îî‚îÄ Result: Heavily modified prompt

5. Storage
   ‚îî‚îÄ Saved to database (modified data)

6. Display
   ‚îî‚îÄ UI shows modified title/description

7. Generation (if user generates image)
   ‚îú‚îÄ Quality validation
   ‚îú‚îÄ May rebuild prompt if checks fail
   ‚îî‚îÄ Sent to Replicate
```

### Pro Mode Flow

```
1. Maya generates concepts
   ‚îú‚îÄ title: "Christmas Morning Cozy"
   ‚îú‚îÄ description: "Cozy holiday morning moment..."
   ‚îî‚îÄ category: "Lifestyle"

2. Direct Prompt Generation
   ‚îú‚îÄ Input: concept.description
   ‚îú‚îÄ Process: generatePromptDirect()
   ‚îú‚îÄ Camera spec override (based on conceptIndex)
   ‚îî‚îÄ Output: concept.prompt (structured prompt)

3. Storage
   ‚îî‚îÄ Saved to database

4. Display
   ‚îî‚îÄ UI shows title/description

5. Generation (if user generates image)
   ‚îú‚îÄ buildNanoBananaPrompt() transforms prompt again
   ‚îî‚îÄ Sent to Nano Banana Pro
```

---

## CRITICAL ISSUES IDENTIFIED

### üî¥ CRITICAL ISSUE #1: Upload Module Override
**Location:** `app/api/maya/generate-concepts/route.ts:2687-2694`

**Problem:** Upload module category/concept **completely replaces** Maya's creative titles and descriptions with generic format.

**Impact:** Maya's creative output is lost when upload module is used.

**Fix Needed:** Preserve Maya's original titles/descriptions, or merge upload module context without replacing.

---

### üî¥ CRITICAL ISSUE #2: Prompt Not Generated by Maya
**Location:** `lib/maya/direct-prompt-generation.ts`

**Problem:** Maya generates **descriptions**, not prompts. Prompts are built by `generatePromptDirect()` which transforms descriptions into structured prompts.

**Impact:** Maya's original creative language is lost in the transformation.

**Fix Needed:** Either:
1. Have Maya generate prompts directly, OR
2. Preserve Maya's original description alongside the generated prompt

---

### üî¥ CRITICAL ISSUE #3: Extensive Post-Processing
**Location:** `app/api/maya/generate-concepts/route.ts:4000-4207`

**Problem:** Massive post-processing modifies prompts after generation:
- Skin texture handling
- iPhone specs enforcement
- Candid/amateur keywords
- Anti-plastic validation
- Lighting modifications

**Impact:** Maya's original prompt is heavily modified before being saved/displayed.

**Fix Needed:** Reduce post-processing, or preserve Maya's original prompt alongside the modified version.

---

### üî¥ CRITICAL ISSUE #4: Prompt Rebuilding at Generation
**Location:** `app/api/maya/generate-image/route.ts:268-333`

**Problem:** Even after all modifications, prompts can be **rebuilt again** at generation time if quality checks fail.

**Impact:** Maya's original prompt may be completely replaced at generation time.

**Fix Needed:** Improve quality checks, or preserve original prompt even if rebuilding is needed.

---

## RECOMMENDATIONS

1. **Preserve Maya's Original Output**
   - Store `mayaOriginalTitle`, `mayaOriginalDescription`, `mayaOriginalPrompt` fields
   - Display both original and modified versions in UI
   - Allow users to see what Maya originally generated

2. **Reduce Post-Processing**
   - Move post-processing to generation time (not concept creation time)
   - Only apply essential modifications
   - Preserve Maya's creative language

3. **Fix Upload Module Override**
   - Merge upload module context without replacing Maya's titles/descriptions
   - Use upload module category as hint, not override

4. **Improve Prompt Generation**
   - Consider having Maya generate prompts directly
   - Or preserve original description alongside generated prompt

5. **Add Debugging/Logging**
   - Log Maya's original output before any modifications
   - Log each modification step
   - Show modification history in UI

---

## CONCLUSION

Maya's creative output is being modified at **multiple points** in the flow:

1. **Upload Module Override** - Replaces titles/descriptions
2. **Direct Prompt Generation** - Transforms descriptions into prompts
3. **Post-Processing** - Heavily modifies prompts (Classic Mode)
4. **Camera Spec Override** - Forces camera specs (Pro Mode)
5. **Prompt Rebuilding** - May rebuild at generation time

**The root cause:** Maya generates descriptions, not prompts, and the system transforms descriptions into prompts with extensive modifications. Maya's original creative output is not preserved.

**The solution:** Preserve Maya's original output at each stage, reduce post-processing, and allow users to see what Maya originally generated vs. what was modified.

