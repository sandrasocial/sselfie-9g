# Feed Feature Audit Report
**Date:** 2025-01-30  
**Purpose:** Comprehensive analysis of feed-related files, logic, and user journey to identify duplicates, conflicts, and cleanup opportunities

---

## Executive Summary

The feed feature has evolved through multiple iterations, resulting in:
- **3+ feed creation endpoints** with overlapping functionality
- **4+ feed fetching endpoints** with duplicate logic
- **2 separate UI components** (Feed Planner vs Maya Feed Tab) with unclear boundaries
- **Duplicate business logic** across multiple files
- **Inconsistent data flow** between frontend and backend

**Critical Issues Found:**
1. Duplicate feed creation logic in 5+ API routes
2. Conflicting feed fetching patterns (latest vs specific vs list)
3. Unclear separation between Feed Planner and Maya Feed Tab
4. Duplicate prompt/caption generation logic
5. Inconsistent error handling and validation

---

## 1. User Journey Analysis

### Current User Flows

#### Flow A: Maya Feed Tab (Primary - Recommended)
1. User opens Maya Chat → Feed Tab
2. User types request (e.g., "Create a beige feed")
3. Maya generates strategy with `[CREATE_FEED_STRATEGY]` trigger
4. `maya-feed-tab.tsx` detects trigger → calls `createFeedFromStrategyHandler()`
5. Handler calls `/api/feed-planner/create-from-strategy`
6. Feed created → displayed in feed list
7. User clicks "Generate Feed" → images generated

**Files Involved:**
- `components/sselfie/maya/maya-feed-tab.tsx` (UI)
- `lib/maya/feed-generation-handler.ts` (Handler)
- `app/api/feed-planner/create-from-strategy/route.ts` (API)

#### Flow B: Feed Planner Screen (Legacy/View-Only)
1. User navigates to `/feed-planner` page
2. `feed-planner-screen.tsx` loads
3. Fetches feed via `/api/feed/latest` or `/api/feed/[feedId]`
4. Displays feed in view-only mode
5. No creation capability (redirects to Maya Feed Tab)

**Files Involved:**
- `app/feed-planner/page.tsx` (Page)
- `components/feed-planner/feed-planner-screen.tsx` (UI)
- `app/api/feed/latest/route.ts` (API)
- `app/api/feed/[feedId]/route.ts` (API)

#### Flow C: Direct API Creation (Legacy)
1. Frontend calls `/api/feed-planner/create-strategy` directly
2. Strategy generated by Claude
3. Feed created synchronously
4. Images queued automatically

**Files Involved:**
- `app/api/feed-planner/create-strategy/route.ts` (API)
- `lib/feed-planner/orchestrator.ts` (Logic)

#### Flow D: Auto-Generate (Legacy)
1. System auto-generates feed after brand profile completion
2. Uses photoshoot session builder
3. Creates feed with consistent styling

**Files Involved:**
- `app/api/feed/auto-generate/route.ts` (API)
- `lib/maya/photoshoot-session.ts` (Logic)

---

## 2. API Endpoints Analysis

### Feed Creation Endpoints

#### ✅ **PRIMARY: `/api/feed-planner/create-from-strategy`**
- **Purpose:** Create feed from Maya's pre-generated strategy
- **Used By:** Maya Feed Tab (Flow A)
- **Status:** ACTIVE - This is the recommended endpoint
- **Location:** `app/api/feed-planner/create-from-strategy/route.ts`
- **Logic:** 
  - Validates prerequisites (credits, model, avatars)
  - Creates feed layout
  - Inserts posts with placeholders
  - Background processing for captions/prompts
  - Does NOT auto-queue images (user must click "Generate Feed")

#### ⚠️ **DUPLICATE: `/api/maya/feed/create-strategy`**
- **Purpose:** Wrapper that forwards to `/api/feed-planner/create-from-strategy`
- **Used By:** None (appears unused)
- **Status:** REDUNDANT - Should be removed
- **Location:** `app/api/maya/feed/create-strategy/route.ts`
- **Issue:** Unnecessary forwarding layer - adds complexity without value

#### ⚠️ **LEGACY: `/api/feed-planner/create-strategy`**
- **Purpose:** Generate strategy from scratch using Claude
- **Used By:** Potentially legacy frontend code
- **Status:** CONFLICTING - Duplicates Maya's strategy generation
- **Location:** `app/api/feed-planner/create-strategy/route.ts`
- **Issue:** 
  - Generates strategy synchronously (slow)
  - Auto-generates captions (duplicates Maya's work)
  - Creates feed immediately (no preview step)
  - Should be deprecated in favor of Maya-generated strategies

#### ⚠️ **LEGACY: `/api/feed/auto-generate`**
- **Purpose:** Auto-generate feed after brand profile completion
- **Used By:** Potentially onboarding flow
- **Status:** LEGACY - May conflict with user-initiated creation
- **Location:** `app/api/feed/auto-generate/route.ts`
- **Issue:** 
  - Creates feed without user request
  - Uses different logic (photoshoot session)
  - May create unwanted feeds

#### ❌ **UNUSED: `/api/agent-coordinator/generate-feed`**
- **Purpose:** Unknown (appears incomplete)
- **Used By:** None
- **Status:** UNUSED - Should be removed
- **Location:** `app/api/agent-coordinator/generate-feed/route.ts`
- **Issue:** Creates feed layout but doesn't complete workflow

### Feed Fetching Endpoints

#### ✅ **PRIMARY: `/api/feed/[feedId]`**
- **Purpose:** Get specific feed by ID (also handles "latest")
- **Used By:** Feed Planner Screen, Feed Publishing Hub
- **Status:** ACTIVE
- **Location:** `app/api/feed/[feedId]/route.ts`
- **Features:**
  - Handles both specific feedId and "latest"
  - Checks Replicate status for pending images
  - Returns feed layout, posts, bios, highlights

#### ⚠️ **DUPLICATE: `/api/feed/latest`**
- **Purpose:** Get user's latest feed
- **Used By:** Feed Planner Screen
- **Status:** REDUNDANT - `/api/feed/[feedId]` handles "latest"
- **Location:** `app/api/feed/latest/route.ts`
- **Issue:** 
  - Duplicates logic from `/api/feed/[feedId]` when feedId="latest"
  - Two endpoints doing the same thing creates confusion
  - Should be consolidated

#### ✅ **PRIMARY: `/api/maya/feed/list`**
- **Purpose:** List all feeds for user (for Feed Tab)
- **Used By:** Maya Feed Tab
- **Status:** ACTIVE
- **Location:** `app/api/maya/feed/list/route.ts`
- **Features:**
  - Returns all feeds with post counts
  - Used for feed list display in Maya Feed Tab

#### ⚠️ **DUPLICATE: `/api/feed-planner/status`**
- **Purpose:** Get feed status and progress
- **Used By:** Potentially legacy frontend
- **Status:** REDUNDANT - Status can be derived from feed data
- **Location:** `app/api/feed-planner/status/route.ts`
- **Issue:** 
  - Duplicates logic from feed fetching endpoints
  - Status calculation should be client-side or part of main feed endpoint

---

## 3. Component Analysis

### Frontend Components

#### ✅ **PRIMARY: `maya-feed-tab.tsx`**
- **Purpose:** Feed creation and management in Maya Chat
- **Location:** `components/sselfie/maya/maya-feed-tab.tsx`
- **Status:** ACTIVE - Primary interface
- **Features:**
  - Detects `[CREATE_FEED_STRATEGY]` trigger
  - Displays feed list
  - Handles feed creation flow
  - Post detail modal
- **Issues:**
  - Large file (797 lines) - could be split
  - Handles both creation and display (could be separated)

#### ⚠️ **LEGACY: `feed-planner-screen.tsx`**
- **Purpose:** View-only feed display
- **Location:** `components/feed-planner/feed-planner-screen.tsx`
- **Status:** VIEW-ONLY - No creation capability
- **Features:**
  - Displays feed from `/api/feed/latest` or `/api/feed/[feedId]`
  - Redirects to Maya Feed Tab for creation
- **Issues:**
  - Name suggests it's for planning, but it's view-only
  - Confusing naming - should be `feed-view-screen.tsx`
  - Uses duplicate fetching logic

#### ✅ **ACTIVE: `instagram-feed-view.tsx`**
- **Purpose:** Detailed feed view with editing capabilities
- **Location:** `components/feed-planner/instagram-feed-view.tsx`
- **Status:** ACTIVE
- **Features:**
  - Displays 9-post grid
  - Post editing
  - Image generation
  - Caption editing

---

## 4. Business Logic Duplication

### Strategy Generation

**Duplicated In:**
1. `lib/feed-planner/orchestrator.ts` - Full orchestration
2. `app/api/feed-planner/create-strategy/route.ts` - Inline Claude generation
3. Maya's system prompt (via `lib/maya/feed-planner-context.ts`)

**Issue:** Strategy generation logic exists in 3 places:
- Maya generates strategy conversationally
- `create-strategy` route generates it via Claude
- `orchestrator.ts` has full orchestration logic

**Recommendation:** 
- Remove `create-strategy` route (use Maya's strategy)
- Keep `orchestrator.ts` for reference but don't use it
- Rely on Maya's conversational strategy generation

### Caption Generation

**Duplicated In:**
1. `lib/feed-planner/caption-writer.ts` - Main caption writer
2. `app/api/feed-planner/create-strategy/route.ts` - Inline caption generation
3. `app/api/feed-planner/create-from-strategy/route.ts` - Background caption generation
4. Maya's strategy JSON (captions in strategy)

**Issue:** Captions generated in 4 places:
- Maya includes captions in strategy JSON
- `caption-writer.ts` generates captions
- `create-strategy` route generates captions
- `create-from-strategy` route generates captions in background

**Recommendation:**
- Use Maya's captions from strategy JSON as primary source
- Use `caption-writer.ts` only for regeneration/editing
- Remove caption generation from `create-strategy` route

### Prompt Generation

**Duplicated In:**
1. `lib/feed-planner/visual-composition-expert.ts` - FLUX prompts
2. `lib/maya/nano-banana-prompt-builder.ts` - Pro Mode prompts
3. `app/api/feed-planner/create-strategy/route.ts` - Inline prompt generation
4. `app/api/feed-planner/create-from-strategy/route.ts` - Background prompt generation
5. Maya's strategy JSON (prompts in strategy)

**Issue:** Prompts generated in 5 places:
- Maya includes prompts in strategy JSON
- `visual-composition-expert.ts` generates FLUX prompts
- `nano-banana-prompt-builder.ts` generates Pro Mode prompts
- `create-strategy` route generates prompts
- `create-from-strategy` route generates prompts in background

**Recommendation:**
- Use Maya's prompts from strategy JSON as primary source
- Use prompt builders only for regeneration/editing
- Remove prompt generation from `create-strategy` route

---

## 5. Data Flow Issues

### Inconsistent Feed Data Structure

**Problem:** Different endpoints return different feed structures:

1. `/api/feed/[feedId]` returns:
```typescript
{
  feed: FeedLayout,
  posts: FeedPost[],
  bio: InstagramBio | null,
  highlights: Highlight[]
}
```

2. `/api/maya/feed/list` returns:
```typescript
{
  feeds: Array<{
    id: number,
    title: string,
    posts: Array<{
      id: number,
      position: number,
      // ... different field names
    }>
  }>
}
```

3. `/api/feed/latest` returns:
```typescript
{
  exists: boolean,
  feed?: FeedLayout,
  posts?: FeedPost[]
}
```

**Issue:** Frontend must handle 3 different response formats

**Recommendation:** Standardize on one feed data structure

### Field Name Inconsistencies

**Problem:** Same data uses different field names:
- `postType` vs `post_type`
- `imageUrl` vs `image_url`
- `generationStatus` vs `generation_status`
- `feedId` vs `id`

**Issue:** Frontend must normalize field names everywhere

**Recommendation:** Use consistent snake_case in database, camelCase in API responses

---

## 6. Critical Conflicts

### Conflict 1: Feed Creation Flow
- **Maya Feed Tab** expects strategy from Maya → calls `create-from-strategy`
- **Legacy code** may call `create-strategy` directly
- **Result:** Two different creation paths with different behaviors

### Conflict 2: Image Generation Timing
- **`create-from-strategy`** does NOT auto-queue images (user must click "Generate Feed")
- **`create-strategy`** auto-queues images immediately
- **Result:** Inconsistent behavior depending on which endpoint is used

### Conflict 3: Feed Fetching
- **Feed Planner Screen** uses `/api/feed/latest`
- **Maya Feed Tab** uses `/api/maya/feed/list`
- **Feed Publishing Hub** uses `/api/feed/[feedId]`
- **Result:** Three different ways to fetch feeds

---

## 7. Cleanup Recommendations

### High Priority (Remove Duplicates)

1. **Remove `/api/maya/feed/create-strategy`**
   - Unused wrapper that forwards to `create-from-strategy`
   - File: `app/api/maya/feed/create-strategy/route.ts`

2. **Deprecate `/api/feed-planner/create-strategy`**
   - Legacy endpoint that duplicates Maya's strategy generation
   - File: `app/api/feed-planner/create-strategy/route.ts`
   - **Action:** Add deprecation notice, redirect to Maya Feed Tab

3. **Consolidate `/api/feed/latest` into `/api/feed/[feedId]`**
   - `/api/feed/[feedId]` already handles "latest" case
   - File: `app/api/feed/latest/route.ts`
   - **Action:** Update frontend to use `/api/feed/latest` instead, then remove duplicate

4. **Remove `/api/agent-coordinator/generate-feed`**
   - Incomplete/unused endpoint
   - File: `app/api/agent-coordinator/generate-feed/route.ts`

5. **Remove `/api/feed-planner/status`**
   - Status can be calculated from feed data
   - File: `app/api/feed-planner/status/route.ts`
   - **Action:** Move status calculation to client-side or include in main feed endpoint

### Medium Priority (Refactor)

6. **Rename `feed-planner-screen.tsx`**
   - Current name suggests planning, but it's view-only
   - **Action:** Rename to `feed-view-screen.tsx` or `feed-display-screen.tsx`

7. **Split `maya-feed-tab.tsx`**
   - Large file (797 lines) handling multiple concerns
   - **Action:** Split into:
     - `maya-feed-list.tsx` (feed list display)
     - `maya-feed-creator.tsx` (feed creation logic)
     - `maya-feed-tab.tsx` (orchestration)

8. **Standardize Feed Data Structure**
   - Create shared TypeScript types
   - **Action:** Create `lib/feed/types.ts` with standardized interfaces

9. **Consolidate Prompt/Caption Generation**
   - Remove duplicate generation from `create-strategy` route
   - Use Maya's strategy JSON as source of truth
   - **Action:** Update `create-from-strategy` to prioritize Maya's prompts/captions

### Low Priority (Optimize)

10. **Review `feed-generation-handler.ts`**
    - Check if all functions are used
    - **Action:** Remove unused functions

11. **Consolidate Feed Fetching Logic**
    - Create shared feed fetching utility
    - **Action:** Create `lib/feed/fetch-feed.ts` with standardized fetching

12. **Document Feed Architecture**
    - Create architecture diagram
    - **Action:** Add to `docs/feed-architecture.md`

---

## 8. Recommended Architecture

### Simplified Flow (After Cleanup)

```
User Request (Maya Feed Tab)
    ↓
Maya Generates Strategy (with [CREATE_FEED_STRATEGY] trigger)
    ↓
maya-feed-tab.tsx detects trigger
    ↓
createFeedFromStrategyHandler() → /api/feed-planner/create-from-strategy
    ↓
Feed Created (posts with placeholders)
    ↓
Background: Captions/Prompts generated (if not in strategy)
    ↓
User Clicks "Generate Feed"
    ↓
Images Generated
    ↓
Feed Complete
```

### API Endpoints (After Cleanup)

**Creation:**
- ✅ `/api/feed-planner/create-from-strategy` (PRIMARY)

**Fetching:**
- ✅ `/api/feed/[feedId]` (handles both specific and "latest")
- ✅ `/api/maya/feed/list` (for feed list in Maya Feed Tab)

**Management:**
- ✅ `/api/feed/[feedId]/generate-images` (image generation)
- ✅ `/api/feed/[feedId]/generate-captions` (caption regeneration)
- ✅ `/api/feed/[feedId]/generate-strategy` (strategy regeneration)

---

## 9. Migration Plan

### Phase 1: Remove Unused Endpoints (Week 1)
1. Remove `/api/maya/feed/create-strategy`
2. Remove `/api/agent-coordinator/generate-feed`
3. Add deprecation notice to `/api/feed-planner/create-strategy`

### Phase 2: Consolidate Fetching (Week 2)
1. Update all frontend code to use `/api/feed/[feedId]` instead of `/api/feed/latest`
2. Remove `/api/feed/latest` endpoint
3. Remove `/api/feed-planner/status` endpoint

### Phase 3: Refactor Components (Week 3)
1. Rename `feed-planner-screen.tsx` to `feed-view-screen.tsx`
2. Split `maya-feed-tab.tsx` into smaller components
3. Create shared feed types

### Phase 4: Standardize Logic (Week 4)
1. Remove duplicate prompt/caption generation from `create-strategy`
2. Update `create-from-strategy` to prioritize Maya's strategy JSON
3. Create shared feed fetching utility

---

## 10. Testing Checklist

After cleanup, verify:
- [ ] Feed creation works via Maya Feed Tab
- [ ] Feed list displays correctly
- [ ] Feed view works for specific feeds
- [ ] Feed view works for latest feed
- [ ] Image generation works
- [ ] Caption regeneration works
- [ ] Strategy regeneration works
- [ ] No broken links or missing endpoints

---

## 11. Files to Review/Remove

### Remove (Unused/Redundant)
- `app/api/maya/feed/create-strategy/route.ts` (unused wrapper)
- `app/api/agent-coordinator/generate-feed/route.ts` (incomplete)
- `app/api/feed/latest/route.ts` (duplicate - use `/api/feed/[feedId]` with "latest")
- `app/api/feed-planner/status/route.ts` (redundant - calculate client-side)

### Deprecate (Legacy)
- `app/api/feed-planner/create-strategy/route.ts` (use Maya's strategy instead)
- `app/api/feed/auto-generate/route.ts` (review if still needed)

### Refactor (Large/Complex)
- `components/sselfie/maya/maya-feed-tab.tsx` (split into smaller components)
- `components/feed-planner/feed-planner-screen.tsx` (rename to reflect view-only nature)
- `app/api/feed-planner/create-from-strategy/route.ts` (remove duplicate prompt/caption generation)

### Keep (Active)
- `app/api/feed-planner/create-from-strategy/route.ts` (PRIMARY creation endpoint)
- `app/api/feed/[feedId]/route.ts` (PRIMARY fetching endpoint)
- `app/api/maya/feed/list/route.ts` (feed list for Maya Feed Tab)
- `lib/feed-planner/caption-writer.ts` (for regeneration)
- `lib/feed-planner/visual-composition-expert.ts` (for regeneration)
- `lib/maya/feed-generation-handler.ts` (orchestration)

---

## 12. Summary

**Total Issues Found:**
- 5 duplicate/redundant API endpoints
- 3 conflicting creation flows
- 4+ places with duplicate business logic
- 3 different feed data structures
- 2 confusing component names

**Impact:**
- High maintenance burden
- Confusing for developers
- Potential bugs from inconsistent behavior
- Slower development velocity

**Recommended Actions:**
1. Remove 4 unused/redundant endpoints
2. Deprecate 2 legacy endpoints
3. Consolidate feed fetching to 1 endpoint
4. Standardize feed data structure
5. Refactor large components
6. Document simplified architecture

**Estimated Cleanup Time:** 2-3 weeks

---

**Next Steps:**
1. Review this audit with team
2. Prioritize cleanup tasks
3. Create GitHub issues for each cleanup item
4. Execute migration plan phase by phase
5. Update documentation after cleanup


